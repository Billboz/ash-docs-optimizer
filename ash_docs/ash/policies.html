<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.34.2">
    <meta name="project" content="ash v3.4.8">


    <title>Policies — ash v3.4.8</title>
    <link rel="stylesheet" href="dist/html-elixir-F2VRIOKR.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-K7URE6B4.js"></script>
    <script src="dist/sidebar_items-370365CE.js"></script>
    <script src="docs_config.js"></script>
    <script async src="dist/html-YIPIRHGU.js"></script>
<style>
  .livebook-badge-container + pre {
    display: none;
  }
</style>
<script>
  if (location.hostname === "hexdocs.pm") {
    var script = document.createElement("script");
    script.src = "https://plausible.io/js/script.js";
    script.setAttribute("defer", "defer")
    script.setAttribute("data-domain", "ashhexdocs")
    document.head.appendChild(script);
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad: true})</script>

  </head>
  <body data-type="extras" class="page-extra">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://github.com/ash-project/ash" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="ash" />
        </a>

      <div>
        <a href="https://github.com/ash-project/ash" class="sidebar-projectName" translate="no">
ash
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v3.4.8
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
GUIDES
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


        <li>
          <button id="tasks-list-tab-button" role="tab" data-type="tasks" aria-controls="tasks-tab-panel" aria-selected="false" tabindex="-1">
            <span translate="no">Mix</span> Tasks
          </button>
        </li>

    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


    <div id="tasks-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="tasks-list-tab-button" hidden>
      <ul id="tasks-full-list" class="full-list"></ul>
    </div>

</nav>

<main class="content">
  <output role="status" id="toast"></output>

  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of ash</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search">
            <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <h1>

      <a href="https://github.com/ash-project/ash/blob/v3.4.8/documentation/topics/security/policies.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>


    <span>Policies</span>
  </h1>

<p>Policies determine what actions on a resource are permitted for a given actor, and can also filter the results of read actions to restrict the results to only records that should be visible.</p><p>To restrict access to specific fields (attributes, aggregates, calculations), see the section on field policies.</p><p>Read and understand the <a href="actors-and-authorization.html">Actors &amp; Authorization guide</a> before proceeding, which explains actors, how to set them, and other relevant configurations.</p><h2 id="setup" class="section-heading">
  <a href="#setup" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Setup</span>
</h2>
<p>You'll need to add the extension to your resource, like so:</p><pre><code class="makeup elixir" translate="no"><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w"> </span><span class="ss">authorizers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0720859017-1">[</span><span class="nc">Ash.Policy.Authorizer</span><span class="p" data-group-id="0720859017-1">]</span></code></pre><p>Then you can start defining policies for your resource.</p><h2 id="policies" class="section-heading">
  <a href="#policies" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Policies</span>
</h2>
<h3 id="anatomy-of-a-policy" class="section-heading">
  <a href="#anatomy-of-a-policy" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Anatomy of a Policy</span>
</h3>
<p>Each policy defined in a resource has two parts -</p><ul><li>a condition, such as <code class="inline">action_type(:read)</code> or <code class="inline">actor_attribute_equals(:admin, true)</code> or <code class="inline">always()</code>. If this condition is true for a given action request, then the policy will be applied to the request.</li><li>a set of policy checks, each of which will be evaluated individually if a policy applies to a request.</li></ul><p>If more than one policy applies to any given request (eg. an admin actor calls a read action) then <strong>all applicable policies must pass</strong> for the action to be performed.</p><p>A policy will produce one of three results: <code class="inline">:forbidden</code>, <code class="inline">:authorized</code>, or <code class="inline">:unknown</code>. <code class="inline">:unknown</code> is treated the same as <code class="inline">:forbidden</code>.</p><h3 id="the-simplest-policy" class="section-heading">
  <a href="#the-simplest-policy" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">The Simplest Policy</span>
</h3>
<p>Let's start with the simplest (most permissive) policy:</p><pre><code class="makeup elixir" translate="no"><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="7546260508-1">do</span><span class="w">
  </span><span class="n">policy</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="7546260508-2">(</span><span class="p" data-group-id="7546260508-2">)</span><span class="w"> </span><span class="k" data-group-id="7546260508-3">do</span><span class="w">
    </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="7546260508-4">(</span><span class="p" data-group-id="7546260508-4">)</span><span class="w">
  </span><span class="k" data-group-id="7546260508-3">end</span><span class="w">
</span><span class="k" data-group-id="7546260508-1">end</span></code></pre><p>The first argument to <code class="inline">policy</code> is the condition. In this case, the condition is <code class="inline">always()</code> - a built-in helper always returning true, meaning that the policy applies to every request.</p><p>Within this policy we have a single policy check, declared with <code class="inline">authorize_if</code>. Checks logically apply from top to bottom, based on their check type. In this case, we'd read the policy as &quot;this policy always applies, and authorizes always&quot;.</p><p>There are four check types, all of which do what they sound like they do:</p><ul><li><code class="inline">authorize_if</code> - if the check is true, the whole policy is authorized.</li><li><code class="inline">authorize_unless</code> - if the check is false, the whole policy is authorized.</li><li><code class="inline">forbid_if</code> - if the check is true, the whole policy is forbidden.</li><li><code class="inline">forbid_unless</code> - if the check is false, the whole policy is forbidden.</li></ul><p>If a single check does not explicitly authorize or forbid the whole policy, then the flow moves to the next check. For example, if an <code class="inline">authorize_if</code> check does NOT return true, this <em>does not mean the whole policy is forbidden</em> - it means that further checking is required.</p><h3 id="how-a-decision-is-reached" class="section-heading">
  <a href="#how-a-decision-is-reached" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">How a Decision is Reached</span>
</h3>
<p><strong>Not every check in a policy must pass!</strong> This is described above, but is very important so another example is provided here. Checks go from top to bottom, are evaluated independently of each other, and <em>the first one that reaches a decision</em> determines the overall <em>policy result</em>. For example:</p><pre><code class="makeup elixir" translate="no"><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="3658993214-1">(</span><span class="ss">:create</span><span class="p" data-group-id="3658993214-1">)</span><span class="w"> </span><span class="k" data-group-id="3658993214-2">do</span><span class="w">
  </span><span class="n">authorize_if</span><span class="w"> </span><span class="nc">IsSuperUser</span><span class="w">
  </span><span class="n">forbid_if</span><span class="w"> </span><span class="nc">Deactivated</span><span class="w">
  </span><span class="n">authorize_if</span><span class="w"> </span><span class="nc">IsAdminUser</span><span class="w">
  </span><span class="n">forbid_if</span><span class="w"> </span><span class="nc">RegularUserCanCreate</span><span class="w">
  </span><span class="n">authorize_if</span><span class="w"> </span><span class="nc">RegularUserAuthorized</span><span class="w">
</span><span class="k" data-group-id="3658993214-2">end</span></code></pre><p>We check those from top to bottom, so the first one of those that returns <code class="inline">:authorized</code> or <code class="inline">:forbidden</code> determines the entire outcome. For example:</p><pre><code class="makeup elixir" translate="no"><span class="n">authorize_if</span><span class="w"> </span><span class="nc">IsSuperUser</span><span class="w"> </span><span class="c1"># If this is true, the actor is a superuser</span><span class="w">

</span><span class="c1"># None of the rest of the checks matter, even if the actor is deactivated.</span><span class="w">
</span><span class="n">forbid_if</span><span class="w"> </span><span class="nc">Deactivated</span><span class="w">
</span><span class="n">authorize_if</span><span class="w"> </span><span class="nc">IsAdminUser</span><span class="w">
</span><span class="n">forbid_if</span><span class="w"> </span><span class="nc">RegularUserCanCreate</span><span class="w">
</span><span class="n">authorize_if</span><span class="w"> </span><span class="nc">RegularUserAuthorized</span></code></pre><p>Conversely:</p><pre><code class="makeup elixir" translate="no"><span class="n">authorize_if</span><span class="w"> </span><span class="nc">IsSuperUser</span><span class="w"> </span><span class="c1"># This can be false</span><span class="w">
</span><span class="n">forbid_if</span><span class="w"> </span><span class="nc">Deactivated</span><span class="w"> </span><span class="c1"># This can be false</span><span class="w">
</span><span class="n">authorize_if</span><span class="w"> </span><span class="nc">IsAdminUser</span><span class="w"> </span><span class="c1"># If this is true, then the policy is still authorized.</span><span class="w">

</span><span class="c1"># And none of these checks matter</span><span class="w">
</span><span class="n">forbid_if</span><span class="w"> </span><span class="nc">RegularUserCanCreate</span><span class="w">
</span><span class="n">authorize_if</span><span class="w"> </span><span class="nc">RegularUserAuthorized</span></code></pre><h3 id="not-all-policy-checks-have-yes-no-answers" class="section-heading">
  <a href="#not-all-policy-checks-have-yes-no-answers" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Not all policy checks have yes/no answers</span>
</h3>
<p>This will be covered in greater detail in <a href="#checks">Checks</a>, but will be briefly mentioned here.</p><p>Ash provides two basic types of policy checks - <em>simple</em> checks and <em>filter</em> checks. Simple checks are what we commonly think of with authorization, and what the above example would suggest - is an actor allowed to perform a given operation, yes or no? But we can also use filter checks - given a list of resources, which ones is an actor allowed to perform the operation on?</p><p>Filter checks are applied to all read actions, including those generated for bulk updates and destroys.</p><h3 id="bypass-policies" class="section-heading">
  <a href="#bypass-policies" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Bypass policies</span>
</h3>
<p>A bypass policy is just like a regular policy, except if a bypass passes, then other policies after it <em>do not need to pass</em>. This can be useful for writing complex access rules, or for a simple rule like &quot;an admin can do anything&quot; without needing to specify it as part of every other policy.</p><h3 id="a-realistic-policy" class="section-heading">
  <a href="#a-realistic-policy" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">A realistic policy</span>
</h3>
<p>In this example, we use some of the provided built-in checks.</p><pre><code class="makeup elixir" translate="no"><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="1677667901-1">do</span><span class="w">
  </span><span class="c1"># Anything you can use in a condition, you can use in a check, and vice-versa</span><span class="w">
  </span><span class="c1"># This policy applies if the actor is a super_user</span><span class="w">
  </span><span class="c1"># Additionally, this policy is declared as a `bypass`. That means that this check is allowed to fail without</span><span class="w">
  </span><span class="c1"># failing the whole request, and that if this check *passes*, the entire request passes.</span><span class="w">
  </span><span class="n">bypass</span><span class="w"> </span><span class="n">actor_attribute_equals</span><span class="p" data-group-id="1677667901-2">(</span><span class="ss">:super_user</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="1677667901-2">)</span><span class="w"> </span><span class="k" data-group-id="1677667901-3">do</span><span class="w">
    </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="1677667901-4">(</span><span class="p" data-group-id="1677667901-4">)</span><span class="w">
  </span><span class="k" data-group-id="1677667901-3">end</span><span class="w">

  </span><span class="c1"># This will likely be a common occurrence. Specifically, policies that apply to all read actions</span><span class="w">
  </span><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="1677667901-5">(</span><span class="ss">:read</span><span class="p" data-group-id="1677667901-5">)</span><span class="w"> </span><span class="k" data-group-id="1677667901-6">do</span><span class="w">
    </span><span class="c1"># unless the actor is an active user, forbid</span><span class="w">
    </span><span class="n">forbid_unless</span><span class="w"> </span><span class="n">actor_attribute_equals</span><span class="p" data-group-id="1677667901-7">(</span><span class="ss">:active</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="1677667901-7">)</span><span class="w">
    </span><span class="c1"># if the record is marked as public, authorize</span><span class="w">
    </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="1677667901-8">(</span><span class="n">public</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="1677667901-8">)</span><span class="w">
    </span><span class="c1"># if the actor is related to the data via that data&#39;s `owner` relationship, authorize</span><span class="w">
    </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">relates_to_actor_via</span><span class="p" data-group-id="1677667901-9">(</span><span class="ss">:owner</span><span class="p" data-group-id="1677667901-9">)</span><span class="w">
  </span><span class="k" data-group-id="1677667901-6">end</span><span class="w">
</span><span class="k" data-group-id="1677667901-1">end</span></code></pre><h2 id="policy-groups" class="section-heading">
  <a href="#policy-groups" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Policy Groups</span>
</h2>
<p>Policy groups are a small abstraction over policies, that allow you to group policies together
that have shared conditions. Each policy inside of a policy group have the same conditions as
their group.</p><pre><code class="makeup elixir" translate="no"><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="9544525349-1">do</span><span class="w">
  </span><span class="n">policy_group</span><span class="w"> </span><span class="n">actor_attribute_equals</span><span class="p" data-group-id="9544525349-2">(</span><span class="ss">:role</span><span class="p">,</span><span class="w"> </span><span class="ss">:owner</span><span class="p" data-group-id="9544525349-2">)</span><span class="w"> </span><span class="k" data-group-id="9544525349-3">do</span><span class="w">
    </span><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="9544525349-4">(</span><span class="ss">:read</span><span class="p" data-group-id="9544525349-4">)</span><span class="w"> </span><span class="k" data-group-id="9544525349-5">do</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="9544525349-6">(</span><span class="n">owner_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">actor</span><span class="p" data-group-id="9544525349-7">(</span><span class="ss">:id</span><span class="p" data-group-id="9544525349-7">)</span><span class="p" data-group-id="9544525349-6">)</span><span class="w">
    </span><span class="k" data-group-id="9544525349-5">end</span><span class="w">

    </span><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="9544525349-8">(</span><span class="p" data-group-id="9544525349-9">[</span><span class="ss">:create</span><span class="p">,</span><span class="w"> </span><span class="ss">:update</span><span class="p">,</span><span class="w"> </span><span class="ss">:destroy</span><span class="p" data-group-id="9544525349-9">]</span><span class="p" data-group-id="9544525349-8">)</span><span class="w"> </span><span class="k" data-group-id="9544525349-10">do</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="9544525349-11">(</span><span class="n">owner_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">actor</span><span class="p" data-group-id="9544525349-12">(</span><span class="ss">:id</span><span class="p" data-group-id="9544525349-12">)</span><span class="p" data-group-id="9544525349-11">)</span><span class="w">
    </span><span class="k" data-group-id="9544525349-10">end</span><span class="w">
  </span><span class="k" data-group-id="9544525349-3">end</span><span class="w">
</span><span class="k" data-group-id="9544525349-1">end</span></code></pre><h3 id="nesting-policy-groups" class="section-heading">
  <a href="#nesting-policy-groups" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Nesting Policy groups</span>
</h3>
<p>Policy groups can be nested. This can help when you have lots of policies and conditions.</p><pre><code class="makeup elixir" translate="no"><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="1457276257-1">do</span><span class="w">
  </span><span class="n">policy_group</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="k" data-group-id="1457276257-2">do</span><span class="w">
    </span><span class="n">policy_group</span><span class="w"> </span><span class="n">condition2</span><span class="w"> </span><span class="k" data-group-id="1457276257-3">do</span><span class="w">
       </span><span class="n">policy</span><span class="w"> </span><span class="n">condition3</span><span class="w"> </span><span class="k" data-group-id="1457276257-4">do</span><span class="w">
         </span><span class="c1"># This policy applies if condition, condition2, and condition3 are all true</span><span class="w">
       </span><span class="k" data-group-id="1457276257-4">end</span><span class="w">
    </span><span class="k" data-group-id="1457276257-3">end</span><span class="w">
  </span><span class="k" data-group-id="1457276257-2">end</span><span class="w">
</span><span class="k" data-group-id="1457276257-1">end</span></code></pre><h3 id="bypasses" class="section-heading">
  <a href="#bypasses" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Bypasses</span>
</h3>
<p>Policy groups can <em>not</em> contain bypass policies. The purpose of policy groups is to make it easier to reason
about the behavior of policies. When you see a policy group, you know that no policies inside that group will
interact with policies in other policy groups, unless they also apply.</p><h3 id="access-type" class="section-heading">
  <a href="#access-type" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Access Type</span>
</h3>
<p>Policies have an &quot;access type&quot; that determines when they are applied. By default, <code class="inline">access_type</code> is <code class="inline">:filter</code>.
When applied to a read action, <code class="inline">:filter</code> will result in a filtered read. For other action types, the filter will be evaluated
to determine if a forbidden error should be raised.</p><p>There are three access types, and they determine the <em>latest point in the process</em> that any check contained by a policy can be applied.</p><ul><li><code class="inline">strict</code> - All checks must be applied statically. These result in a forbidden error if they are not met.</li><li><code class="inline">filter</code> - All checks must be applied either statically or as a filter. These result in a filtered read if they are not met, and a
forbidden error for other action types.</li><li><code class="inline">runtime</code> - This allows checks to be run <em>after</em> the data has been read. It is exceedingly rare that you would need to use this access type.</li></ul><p>For example, given this policy:</p><pre><code class="makeup elixir" translate="no"><span class="n">policy</span><span class="w"> </span><span class="n">action</span><span class="p" data-group-id="6602003568-1">(</span><span class="ss">:read_hidden</span><span class="p" data-group-id="6602003568-1">)</span><span class="w"> </span><span class="k" data-group-id="6602003568-2">do</span><span class="w">
  </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="6602003568-3">(</span><span class="n">actor</span><span class="o">.</span><span class="n">is_admin</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="6602003568-3">)</span><span class="w">
</span><span class="k" data-group-id="6602003568-2">end</span></code></pre><p>A non-admin using the <code class="inline">:read_hidden</code> action would see an empty list of records, rather than a forbidden error.</p><p>However, with this policy</p><pre><code class="makeup elixir" translate="no"><span class="n">policy</span><span class="w"> </span><span class="n">action</span><span class="p" data-group-id="8651650666-1">(</span><span class="ss">:read_hidden</span><span class="p" data-group-id="8651650666-1">)</span><span class="w"> </span><span class="k" data-group-id="8651650666-2">do</span><span class="w">
  </span><span class="n">access_type</span><span class="w"> </span><span class="ss">:strict</span><span class="w">

  </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="8651650666-3">(</span><span class="n">actor</span><span class="o">.</span><span class="n">is_admin</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="8651650666-3">)</span><span class="w">
</span><span class="k" data-group-id="8651650666-2">end</span></code></pre><p>A non-admin using the <code class="inline">:read_hidden</code> action would see a forbidden error.</p><h2 id="checks" class="section-heading">
  <a href="#checks" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Checks</span>
</h2>
<p>Checks evaluate from top to bottom within a policy. A check can produce one of three results, the same that a policy can produce. While checks are not necessarily evaluated in order, they <em>logically apply</em> in that order, so you may as well think of it in that way. It can be thought of as a step-through algorithm.</p><p>For each check, starting from the top:</p><ul><li>Run the check.<ul><li>If it returns <code class="inline">:authorized</code>, the policy is <code class="inline">:authorized</code></li><li>If it returns <code class="inline">:forbidden</code>, the policy is <code class="inline">:forbidden</code></li><li>If it returns <code class="inline">:unknown</code>, the next check down is checked</li></ul></li></ul><p>For the example from earlier:</p><ul><li><code class="inline">authorize_if IsSuperUser</code><ul><li>If this check succeeds, it returns <code class="inline">:authorized</code>, the whole policy is <code class="inline">:authorized</code>, and checks stop running</li><li>If this check fails, it returns <code class="inline">:unknown</code> and the next check is checked</li></ul></li><li><code class="inline">forbid_if Deactivated</code><ul><li>We only care about this result if the previous check failed, ie. the actor is not a super user.</li><li>If this check succeeds, it returns <code class="inline">:forbidden</code>, the whole policy is <code class="inline">:forbidden</code>, and checks stop running</li><li>If this check fails, it returns <code class="inline">:unknown</code> and the next check is checked</li></ul></li><li><code class="inline">authorize_if IsAdminUser</code><ul><li>We only care about this result if the previous checks failed, ie. the actor is not a super user and is not deactivated.</li><li>If this check succeeds, it returns <code class="inline">:authorized</code>, the whole policy is <code class="inline">:authorized</code> and checks stop running.</li><li>If this check fails, it returns <code class="inline">:unknown</code> and the next check is checked</li></ul></li><li><code class="inline">authorize_if RegularUserAuthorized</code><ul><li>We only care about this result if the previous checks failed, ie. the actor is not a super user, not deactivated and not an admin user.</li><li>If this check succeeds, it returns <code class="inline">:authorized</code>, the whole policy is <code class="inline">:authorized</code> and checks stop running.</li><li>If this check fails, it returns <code class="inline">:unknown</code>. As there are no more checks to run, the whole policy returns <code class="inline">:unknown</code>, which is treated as forbidden and the actor is not allowed to perform the action.</li></ul></li></ul><h3 id="types-of-checks" class="section-heading">
  <a href="#types-of-checks" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Types of checks</span>
</h3>
<p>As mentioned earlier, there are two distinct types of checks - <em>simple</em> checks and <em>filter</em> checks. So far we've seen examples of both - let's look in a bit more detail.</p><blockquote><h4 class="neutral">Manual Checks</h4><p>Both simple and filter checks are a subset of a third type of check - a <em>manual</em> check - but you will almost always want to write simple or filter checks.</p></blockquote><h4>Simple checks</h4><p>Simple checks are determined at the outset of a request, and can only cause a request to be authorized or forbidden. These are typically yes/no questions - is the actor an admin? Did the actor create the post they want to call the <code class="inline">update</code> action on? Is the actor old enough to drink alcohol?</p><p>You can write a simple check by creating a new module and using the <a href="Ash.Policy.SimpleCheck.html"><code class="inline">Ash.Policy.SimpleCheck</code></a> module:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Checks.ActorIsOldEnough</span><span class="w"> </span><span class="k" data-group-id="9440040631-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Policy.SimpleCheck</span><span class="w">

  </span><span class="c1"># This is used when logging a breakdown of how a policy is applied - see Logging below.</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">describe</span><span class="p" data-group-id="9440040631-2">(</span><span class="bp">_</span><span class="p" data-group-id="9440040631-2">)</span><span class="w"> </span><span class="k" data-group-id="9440040631-3">do</span><span class="w">
    </span><span class="s">&quot;actor is old enough&quot;</span><span class="w">
  </span><span class="k" data-group-id="9440040631-3">end</span><span class="w">

  </span><span class="c1"># The context here may have a changeset, query, resource, and domain module, depending</span><span class="w">
  </span><span class="c1"># on the action being run.</span><span class="w">
  </span><span class="c1"># `match?` should return true or false, and answer the statement being posed in the description,</span><span class="w">
  </span><span class="c1"># i.e &quot;is the actor old enough?&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">match?</span><span class="p" data-group-id="9440040631-4">(</span><span class="p" data-group-id="9440040631-5">%</span><span class="nc" data-group-id="9440040631-5">MyApp.User</span><span class="p" data-group-id="9440040631-5">{</span><span class="ss">age</span><span class="p">:</span><span class="w"> </span><span class="n">age</span><span class="p" data-group-id="9440040631-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c">_actor</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9440040631-6">%{</span><span class="ss">resource</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Beer</span><span class="p" data-group-id="9440040631-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c">_context</span><span class="p">,</span><span class="w"> </span><span class="c">_opts</span><span class="p" data-group-id="9440040631-4">)</span><span class="w"> </span><span class="k" data-group-id="9440040631-7">do</span><span class="w">
    </span><span class="n">age</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">21</span><span class="w">
  </span><span class="k" data-group-id="9440040631-7">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">match?</span><span class="p" data-group-id="9440040631-8">(</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="9440040631-8">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
</span><span class="k" data-group-id="9440040631-1">end</span></code></pre><p>You can then use this module as the check name, as part of a policy:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Beer</span><span class="w"> </span><span class="k" data-group-id="3824393983-1">do</span><span class="w">
  </span><span class="c1"># ...</span><span class="w">

  </span><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="3824393983-2">do</span><span class="w">
    </span><span class="n">policy</span><span class="w"> </span><span class="n">action</span><span class="p" data-group-id="3824393983-3">(</span><span class="ss">:drink</span><span class="p" data-group-id="3824393983-3">)</span><span class="w"> </span><span class="k" data-group-id="3824393983-4">do</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="nc">MyApp.Checks.ActorIsOldEnough</span><span class="w">
    </span><span class="k" data-group-id="3824393983-4">end</span><span class="w">
  </span><span class="k" data-group-id="3824393983-2">end</span><span class="w">

  </span><span class="c1"># ...</span><span class="w">
</span><span class="k" data-group-id="3824393983-1">end</span></code></pre><p>Ash will internally convert the true/false return value from <code class="inline">match?/3</code> to a <code class="inline">:authorized</code>/<code class="inline">:forbidden</code>/<code class="inline">:unknown</code> response, depending on how the check is being run (ie. whether it's part of an <code class="inline">authorize_if</code>/<code class="inline">forbid_if</code>/etc.)</p><h4>Filter checks</h4><p>Many checks won't return a status yes/no, but instead return a &quot;filter&quot; to apply to a collection of data. They are most commonly used for read actions, but can be used for all types of actions.</p><p>For update and destroy actions, they apply to the data <em>before</em> the action is run.</p><p>For read actions, they will automatically restrict the returned data to be compliant with the filter. Using the drinking example from earlier, we could write a filter check to list only users that are old enough to drink alcohol.</p><p>There are two ways to write a filter check - by creating a module and using the <a href="Ash.Policy.FilterCheck.html"><code class="inline">Ash.Policy.FilterCheck</code></a> module, or by using inline expression syntax.</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Checks.ActorOverAgeLimit</span><span class="w"> </span><span class="k" data-group-id="4866735921-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Policy.FilterCheck</span><span class="w">

  </span><span class="c1"># A description is not necessary, as it will be derived from the filter, but one could be added</span><span class="w">
  </span><span class="c1"># def describe(_opts), do: &quot;actor is over the age limit&quot;</span><span class="w">

  </span><span class="c1"># Filter checks don&#39;t have a `context` available to them</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">filter</span><span class="p" data-group-id="4866735921-2">(</span><span class="c">_options</span><span class="p" data-group-id="4866735921-2">)</span><span class="w"> </span><span class="k" data-group-id="4866735921-3">do</span><span class="w">
    </span><span class="n">expr</span><span class="p" data-group-id="4866735921-4">(</span><span class="n">age_limit</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">^</span><span class="n">actor</span><span class="p" data-group-id="4866735921-5">(</span><span class="ss">:age</span><span class="p" data-group-id="4866735921-5">)</span><span class="p" data-group-id="4866735921-4">)</span><span class="w">
  </span><span class="k" data-group-id="4866735921-3">end</span><span class="w">
</span><span class="k" data-group-id="4866735921-1">end</span></code></pre><p>You can then use this module as the check name, as part of a policy:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.User</span><span class="w"> </span><span class="k" data-group-id="8165621771-1">do</span><span class="w">
  </span><span class="c1"># ...</span><span class="w">

  </span><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="8165621771-2">do</span><span class="w">
    </span><span class="n">policy</span><span class="w"> </span><span class="n">action</span><span class="p" data-group-id="8165621771-3">(</span><span class="ss">:of_drinking_age</span><span class="p" data-group-id="8165621771-3">)</span><span class="w"> </span><span class="k" data-group-id="8165621771-4">do</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="nc">MyApp.Checks.ActorOverAgeLimit</span><span class="w">
    </span><span class="k" data-group-id="8165621771-4">end</span><span class="w">
  </span><span class="k" data-group-id="8165621771-2">end</span><span class="w">

  </span><span class="c1"># ...</span><span class="w">
</span><span class="k" data-group-id="8165621771-1">end</span></code></pre><h4>Inline checks</h4><p>Inline checks are filter checks, but are different enough to warrant their own documentation. These are written directly in a policy, eg.</p><pre><code class="makeup elixir" translate="no"><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="8753365129-1">(</span><span class="ss">:read</span><span class="p" data-group-id="8753365129-1">)</span><span class="w"> </span><span class="k" data-group-id="8753365129-2">do</span><span class="w">
  </span><span class="c1"># Allow records with the attribute `public` set to true to be read</span><span class="w">
  </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="8753365129-3">(</span><span class="n">public</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="8753365129-3">)</span><span class="w">

  </span><span class="c1"># Allow records with the attribute `level` less than the value of the `level`</span><span class="w">
  </span><span class="c1"># argument to the action to be read</span><span class="w">
  </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="8753365129-4">(</span><span class="n">level</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">^</span><span class="n">arg</span><span class="p" data-group-id="8753365129-5">(</span><span class="ss">:level</span><span class="p" data-group-id="8753365129-5">)</span><span class="p" data-group-id="8753365129-4">)</span><span class="w">
</span><span class="k" data-group-id="8753365129-2">end</span></code></pre><p>Keep in mind that, for create actions, many <code class="inline">expr/1</code> checks won't make sense, and may return <code class="inline">false</code> when you wouldn't expect. Expression (and other filter) policies apply to &quot;a synthesized result&quot; of applying the action, so related values won't be available. For this reason, you may end up wanting to use other checks that are built for working against changesets, or only simple attribute-based filter checks. Custom checks may also be warranted here.</p><p>Ash also comes with a set of built-in helpers for writing inline checks - see <a href="Ash.Policy.Check.Builtins.html"><code class="inline">Ash.Policy.Check.Builtins</code></a> for more information.</p><h5>Referencing the actor</h5><p>In expression checks, the <code class="inline">actor</code> template can be used (other templates that may work in filter expressions, for example, are not available). For example:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># Authorize records that have an author relationship with the author ID the same as the actor ID</span><span class="w">
</span><span class="c1"># ie. records authored by the actor</span><span class="w">
</span><span class="n">authorize_if</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="1006942820-1">(</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">^</span><span class="n">actor</span><span class="p" data-group-id="1006942820-2">(</span><span class="ss">:id</span><span class="p" data-group-id="1006942820-2">)</span><span class="p" data-group-id="1006942820-1">)</span></code></pre><h5>Using <code class="inline">exists</code></h5><p>A common mistake when using related data in filters is to be too restrictive. Imagine a scenario where you have an action like this:</p><pre><code class="makeup elixir" translate="no"><span class="n">read</span><span class="w"> </span><span class="ss">:friends_of_ted</span><span class="w"> </span><span class="k" data-group-id="4690467427-1">do</span><span class="w">
  </span><span class="n">filter</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="4690467427-2">(</span><span class="n">friends</span><span class="o">.</span><span class="n">first_name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ted&quot;</span><span class="p" data-group-id="4690467427-2">)</span><span class="w">
</span><span class="k" data-group-id="4690467427-1">end</span></code></pre><p>If this was in a User resource, it would return users that have a friend with the first name &quot;ted&quot;. So far so good. Then someone calls it like so:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Resource</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">for_read</span><span class="p" data-group-id="7530477549-1">(</span><span class="ss">:friends_of_ted</span><span class="p" data-group-id="7530477549-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="7530477549-2">(</span><span class="n">friends</span><span class="o">.</span><span class="n">last_name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;dansen&quot;</span><span class="p" data-group-id="7530477549-2">)</span></code></pre><p>The resulting filter is <code class="inline">friends.first_name == &quot;ted&quot; and friends.last_name == &quot;dansen&quot;</code>- this means that you'll get users that have a friend with the full name &quot;ted dansen&quot;. That <em>might</em> be what you meant, but more likely you would want &quot;users that have a friend with the first name &quot;ted&quot;, that also have a friend with the last name 'dansen'&quot;.</p><p>To accomplish that, we can use the <code class="inline">exists</code> helper and rework the example like so:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># There exists a friend with the first name &quot;ted&quot;</span><span class="w">
</span><span class="n">read</span><span class="w"> </span><span class="ss">:friends_of_ted</span><span class="w"> </span><span class="k" data-group-id="1553900551-1">do</span><span class="w">
  </span><span class="n">filter</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="1553900551-2">(</span><span class="n">exists</span><span class="p" data-group-id="1553900551-3">(</span><span class="n">friends</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;ted&quot;</span><span class="p" data-group-id="1553900551-3">)</span><span class="p" data-group-id="1553900551-2">)</span><span class="w">
</span><span class="k" data-group-id="1553900551-1">end</span><span class="w">

</span><span class="c1"># And there also exists a friend with the last name &quot;dansen&quot;</span><span class="w">
</span><span class="c1"># They may be the same friend if the user is friends with Ted Dansen!</span><span class="w">
</span><span class="nc">Resource</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">for_read</span><span class="p" data-group-id="1553900551-4">(</span><span class="ss">:friends_of_ted</span><span class="p" data-group-id="1553900551-4">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="1553900551-5">(</span><span class="n">exists</span><span class="p" data-group-id="1553900551-6">(</span><span class="n">friends</span><span class="p">,</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;dansen&quot;</span><span class="p" data-group-id="1553900551-6">)</span><span class="p" data-group-id="1553900551-5">)</span></code></pre><p>In policies (and often any time you mean &quot;a related thing exists where some condition is true&quot;), it is advised to use <code class="inline">exists/2</code> when referring to relationships because of the way that the policy authorizer may mix &amp; match your policies when building filters. This is also true when adding filters to actions. If you use <code class="inline">exists</code>, then your policies can be used in filters without excluding unnecessary data.</p><h2 id="field-policies" class="section-heading">
  <a href="#field-policies" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Field Policies</span>
</h2>
<p>Field policies allow you to authorize access to specific fields via policies scoped to fields.</p><p>For example:</p><pre><code class="makeup elixir" translate="no"><span class="n">field_policies</span><span class="w"> </span><span class="k" data-group-id="3926575637-1">do</span><span class="w">
  </span><span class="n">field_policy</span><span class="w"> </span><span class="ss">:role</span><span class="w"> </span><span class="k" data-group-id="3926575637-2">do</span><span class="w">
    </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">actor_attribute_equals</span><span class="p" data-group-id="3926575637-3">(</span><span class="ss">:role</span><span class="p">,</span><span class="w"> </span><span class="ss">:supervisor</span><span class="p" data-group-id="3926575637-3">)</span><span class="w">
  </span><span class="k" data-group-id="3926575637-2">end</span><span class="w">
</span><span class="k" data-group-id="3926575637-1">end</span></code></pre><p>If <em>any</em> field policies exist then <em>all</em> fields must be authorized by a field policy.
If you want a &quot;deny-list&quot; style, then you can add policies for specific fields.
and add a catch-all policy using the special field name <code class="inline">:*</code>. All policies that apply
to a field must be authorized.</p><p>The only exception to the above behavior is primary keys, which can always be read by everyone.</p><p>Additionally, keep in mind that adding <a href="Ash.Policy.Authorizer.html"><code class="inline">Ash.Policy.Authorizer</code></a> will require that all actions
pass policies. If you want to just add field policies, you will need to add a policy that allows
all access explicitly, i.e</p><pre><code class="makeup elixir" translate="no"><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="7069021730-1">do</span><span class="w">
  </span><span class="n">policy</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="7069021730-2">(</span><span class="p" data-group-id="7069021730-2">)</span><span class="w"> </span><span class="k" data-group-id="7069021730-3">do</span><span class="w">
    </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="7069021730-4">(</span><span class="p" data-group-id="7069021730-4">)</span><span class="w">
  </span><span class="k" data-group-id="7069021730-3">end</span><span class="w">
</span><span class="k" data-group-id="7069021730-1">end</span></code></pre><h3 id="using-expressions-in-field-policies" class="section-heading">
  <a href="#using-expressions-in-field-policies" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Using Expressions In Field Policies</span>
</h3>
<p>Unlike in regular policies, expressions in field policies cannot refer to related entities currently (except when using exists). Instead, you will need to create aggregates or expression calculations that return the results you want to reference.</p><p>In results, forbidden fields will be replaced with a special value: <code class="inline">%Ash.ForbiddenField{}</code>.</p><p>When these fields are referred to in filters, they will be replaced with an expression that evaluates to <code class="inline">nil</code>. To support this behavior, only simple and filter checks are allowed in field policies.</p><h3 id="handeling-private-fields-in-internal-functions" class="section-heading">
  <a href="#handeling-private-fields-in-internal-functions" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Handeling private fields in internal functions</span>
</h3>
<p>When calling internal functions like <a href="Ash.html#read!/1"><code class="inline">Ash.read!/1</code></a>, private fields will by default always be shown.
Even if field policies applies to the resource. You can change the default behaviour by setting the
<code class="inline">private_fields</code> option on field policies.</p><pre><code class="makeup elixir" translate="no"><span class="n">field_policies</span><span class="w"> </span><span class="k" data-group-id="1725647999-1">do</span><span class="w">
  </span><span class="n">private_fields</span><span class="w"> </span><span class="ss">:include</span><span class="w">
</span><span class="k" data-group-id="1725647999-1">end</span></code></pre><p>The different options are:</p><ul><li><code class="inline">:show</code> will always show private fields</li><li><code class="inline">:hide</code> will always hide private fields</li><li><code class="inline">:include</code> will let you to write field policies for private fields and private fields
will be shown or hidden depending on the outcome of the policy</li></ul><p>If you want to overwrite the default option that is <code class="inline">:show</code>, you can do that by setting a global flag:</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:ash</span><span class="p">,</span><span class="w"> </span><span class="ss">:policies</span><span class="p">,</span><span class="w"> </span><span class="ss">private_fields</span><span class="p">:</span><span class="w"> </span><span class="ss">:include</span></code></pre><h2 id="debugging-and-logging" class="section-heading">
  <a href="#debugging-and-logging" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Debugging and Logging</span>
</h2>
<h3 id="policy-breakdowns" class="section-heading">
  <a href="#policy-breakdowns" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Policy Breakdowns</span>
</h3>
<p>Policy breakdowns can be fetched on demand for a given forbidden error (either an <a href="Ash.Error.Forbidden.html"><code class="inline">Ash.Error.Forbidden</code></a> that contains one ore more <a href="Ash.Error.Forbidden.Policy.html"><code class="inline">Ash.Error.Forbidden.Policy</code></a> errors, or an <a href="Ash.Error.Forbidden.Policy.html"><code class="inline">Ash.Error.Forbidden.Policy</code></a> error itself), via <a href="Ash.Error.Forbidden.Policy.html#report/2"><code class="inline">Ash.Error.Forbidden.Policy.report/2</code></a>.</p><p>Additionally, you can request that they be provided in the error message for all raised forbidden errors (without the help text), by setting</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:ash</span><span class="p">,</span><span class="w"> </span><span class="ss">:policies</span><span class="p">,</span><span class="w"> </span><span class="ss">show_policy_breakdowns?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span></code></pre><p>Here is an example policy breakdown from tests.</p><pre><code class="text">Policy Breakdown
A check status of `?` implies that the solver did not need to determine that check.
Some checks may look like they failed when in reality there was no need to check them.
Look for policies with `✘` and `✓` in check statuses.

A check with a `⬇` means that it didn't determine if the policy was authorized or forbidden, and so moved on to the next check.
`🌟` and `⛔` mean that the check was responsible for producing an authorized or forbidden (respectively) status.

If no check results in a status (they all have `⬇`) then the policy is assumed to have failed. In some cases, however, the policy
may have just been ignored, as described above.

  Admins and managers can create posts | ⛔:
    authorize if: actor.admin == true | ✘ | ⬇
    authorize if: actor.manager == true | ✘ | ⬇</code></pre><p>To remove the help text, you can pass the <code class="inline">help_text?: false</code> option, which would leave you with:</p><pre><code class="text">Policy Breakdown
  Admins and managers can create posts | ⛔:
    authorize if: actor.admin == true | ✘ | ⬇
    authorize if: actor.manager == true | ✘ | ⬇</code></pre><h3 id="including-in-error-messages" class="section-heading">
  <a href="#including-in-error-messages" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Including in error messages</span>
</h3>
<p><strong>IMPORTANT WARNING:</strong> The following configuration should only ever be used in development mode!</p><p>For security reasons, authorization errors don't include any extra information, aside from <code class="inline">forbidden</code>. To have authorization errors include a policy breakdown (without help text) use the following config.</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:ash</span><span class="p">,</span><span class="w"> </span><span class="ss">:policies</span><span class="p">,</span><span class="w"> </span><span class="ss">show_policy_breakdowns?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span></code></pre><h3 id="logging" class="section-heading">
  <a href="#logging" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Logging</span>
</h3>
<p>It is generally safe to log authorization error details, even in production. This can be very helpful when investigating certain classes of issue.</p><p>To have Ash automatically log each authorization failure, use</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:ash</span><span class="p">,</span><span class="w"> </span><span class="ss">:policies</span><span class="p">,</span><span class="w"> </span><span class="ss">log_policy_breakdowns</span><span class="p">:</span><span class="w"> </span><span class="ss">:error</span><span class="w"> </span><span class="c1"># Use whatever log level you&#39;d like to use here</span></code></pre><p>To have Ash log all policy breakdowns, even successful ones (this will be lots of noise, and should only be used for dev testing)</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:ash</span><span class="p">,</span><span class="w"> </span><span class="ss">:policies</span><span class="p">,</span><span class="w"> </span><span class="ss">log_successful_policy_breakdowns</span><span class="p">:</span><span class="w"> </span><span class="ss">:error</span><span class="w"> </span><span class="c1"># Use whatever log level you&#39;d like to use here</span></code></pre>
</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="sensitive-data.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Sensitive Data
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="project-structure.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Project Structure
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/ash/3.4.8" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/ash/3.4.8">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/ash/3.4.8/show/documentation/topics/security/policies.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="ash.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.34.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
