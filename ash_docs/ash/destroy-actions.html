<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.34.2">
    <meta name="project" content="ash v3.4.8">


    <title>Destroy Actions — ash v3.4.8</title>
    <link rel="stylesheet" href="dist/html-elixir-F2VRIOKR.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-K7URE6B4.js"></script>
    <script src="dist/sidebar_items-370365CE.js"></script>
    <script src="docs_config.js"></script>
    <script async src="dist/html-YIPIRHGU.js"></script>
<style>
  .livebook-badge-container + pre {
    display: none;
  }
</style>
<script>
  if (location.hostname === "hexdocs.pm") {
    var script = document.createElement("script");
    script.src = "https://plausible.io/js/script.js";
    script.setAttribute("defer", "defer")
    script.setAttribute("data-domain", "ashhexdocs")
    document.head.appendChild(script);
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad: true})</script>

  </head>
  <body data-type="extras" class="page-extra">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://github.com/ash-project/ash" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="ash" />
        </a>

      <div>
        <a href="https://github.com/ash-project/ash" class="sidebar-projectName" translate="no">
ash
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v3.4.8
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
GUIDES
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


        <li>
          <button id="tasks-list-tab-button" role="tab" data-type="tasks" aria-controls="tasks-tab-panel" aria-selected="false" tabindex="-1">
            <span translate="no">Mix</span> Tasks
          </button>
        </li>

    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


    <div id="tasks-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="tasks-list-tab-button" hidden>
      <ul id="tasks-full-list" class="full-list"></ul>
    </div>

</nav>

<main class="content">
  <output role="status" id="toast"></output>

  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of ash</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search">
            <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <h1>

      <a href="https://github.com/ash-project/ash/blob/v3.4.8/documentation/topics/actions/destroy-actions.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>


    <span>Destroy Actions</span>
  </h1>

<p>Destroy actions are comparatively simple. They expect to remove a given record, and by default return <code class="inline">:ok</code> in the successful case.</p><p>Most destroy actions are one-liners, for example:</p><pre><code class="makeup elixir" translate="no"><span class="n">destroy</span><span class="w"> </span><span class="ss">:destroy</span><span class="w">
</span><span class="c1"># Can be added with the defaults</span><span class="w">
</span><span class="n">defaults</span><span class="w"> </span><span class="p" data-group-id="6661798999-1">[</span><span class="ss">:read</span><span class="p">,</span><span class="w"> </span><span class="ss">:destroy</span><span class="p" data-group-id="6661798999-1">]</span></code></pre><h2 id="soft-destroy" class="section-heading">
  <a href="#soft-destroy" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Soft Destroy</span>
</h2>
<p>You can mark a destroy action as <code class="inline">soft? true</code>, in which case it is handled by the <a href="update-actions.html"><code class="inline">update</code> action</a> logic.</p><p>For example:</p><pre><code class="makeup elixir" translate="no"><span class="n">destroy</span><span class="w"> </span><span class="ss">:archive</span><span class="w"> </span><span class="k" data-group-id="9670790744-1">do</span><span class="w">
  </span><span class="n">soft?</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="n">change</span><span class="w"> </span><span class="n">set_attribute</span><span class="p" data-group-id="9670790744-2">(</span><span class="ss">:archived_at</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="o">/</span><span class="mi">0</span><span class="p" data-group-id="9670790744-2">)</span><span class="w">
</span><span class="k" data-group-id="9670790744-1">end</span></code></pre><h2 id="returning-the-destroyed-record" class="section-heading">
  <a href="#returning-the-destroyed-record" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Returning the destroyed record</span>
</h2>
<p>You can use the <code class="inline">return_destroyed?</code> option to return the destroyed record.</p><pre><code class="makeup elixir" translate="no"><span class="n">ticket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">get!</span><span class="p" data-group-id="8563608664-1">(</span><span class="nc">Ticket</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="8563608664-1">)</span><span class="w">
</span><span class="nc">Ash</span><span class="o">.</span><span class="n">destroy!</span><span class="p" data-group-id="8563608664-2">(</span><span class="n">ticket</span><span class="p" data-group-id="8563608664-2">)</span><span class="w">
</span><span class="c1"># =&gt; :ok</span><span class="w">
</span><span class="n">ticket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">get!</span><span class="p" data-group-id="8563608664-3">(</span><span class="nc">Ticket</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="8563608664-3">)</span><span class="w">
</span><span class="nc">Ash</span><span class="o">.</span><span class="n">destroy!</span><span class="p" data-group-id="8563608664-4">(</span><span class="n">ticket</span><span class="p">,</span><span class="w"> </span><span class="ss">return_destroyed?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="8563608664-4">)</span><span class="w">
</span><span class="c1"># =&gt; {:ok, %Ticket{}}</span></code></pre><blockquote><h3 id="loading-on-destroyed-records" class="warning section-heading">
  <a href="#loading-on-destroyed-records" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Loading on destroyed records</span>
</h3>
<p>Keep in mind that using <code class="inline">Ash.load</code> on destroyed data will produced mixed results. Relationships may appear as empty, or may be loaded as expected (depending on the data layer/relationship implementation) and calculations/aggregates may show as <code class="inline">nil</code> if they must be run in the data layer.</p></blockquote><h2 id="bulk-destroys" class="section-heading">
  <a href="#bulk-destroys" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Bulk Destroys</span>
</h2>
<p>There are three strategies for bulk destroying data. They are, in order of preference: <code class="inline">:atomic</code>, <code class="inline">:atomic_batches</code>, and <code class="inline">:stream</code>. When calling <a href="Ash.html#bulk_destroy/4"><code class="inline">Ash.bulk_destroy/4</code></a>, you can provide a strategy or strategies that can be used, and Ash will choose the best one available. The capabilities of the data layer determine what strategies can be used.</p><h2 id="atomic" class="section-heading">
  <a href="#atomic" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Atomic</span>
</h2>
<p>Atomic bulk destroys are used when the subject of the bulk destroy is a query and the data layer supports destroying a query. They map to a single statement to the data layer to destroy all matching records.</p><h3 id="example" class="section-heading">
  <a href="#example" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Example</span>
</h3>
<pre><code class="makeup elixir" translate="no"><span class="nc">Ticket</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="0036509312-1">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:open</span><span class="p" data-group-id="0036509312-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">bulk_destroy!</span><span class="p" data-group-id="0036509312-2">(</span><span class="ss">:close</span><span class="p" data-group-id="0036509312-2">)</span></code></pre><p>If using a SQL data layer, this would produce a query along the lines of</p><pre><code class="sql">DELETE FROM tickets
WHERE status = 'open';</code></pre><h2 id="atomic-batches" class="section-heading">
  <a href="#atomic-batches" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Atomic Batches</span>
</h2>
<p>Atomic batches are used when the subject of the bulk destroy is an enumerable (i.e list or stream) of records and the data layer supports destroying a query. The records are pulled out in batches, and then each batch follows the logic described <a href="#atomic">above</a>. The batch size is controllable by the <code class="inline">batch_size</code> option.</p><h3 id="example-1" class="section-heading">
  <a href="#example-1" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Example</span>
</h3>
<pre><code class="makeup elixir" translate="no"><span class="w">
</span><span class="nc">Ash</span><span class="o">.</span><span class="n">bulk_destroy!</span><span class="p" data-group-id="1173524254-1">(</span><span class="n">one_hundred_tickets</span><span class="p">,</span><span class="w"> </span><span class="ss">:close</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1173524254-2">%{</span><span class="p" data-group-id="1173524254-2">}</span><span class="p">,</span><span class="w"> </span><span class="ss">batch_size</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="1173524254-1">)</span></code></pre><p>If using a SQL data layer, this would produce ten queries along the lines of</p><pre><code class="sql">DELETE FROM tickets
WHERE id IN (...ids)</code></pre><h2 id="stream" class="section-heading">
  <a href="#stream" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Stream</span>
</h2>
<p>Stream is used when the data layer does not support destroying a query. If a query is given, it is run and the records are used as an enumerable of inputs. If an enumerable of inputs is given, each one is destroyed individually. There is nothing inherently wrong with doing this kind of destroy, but it will naturally be slower than the other two strategies.
The benefit of having a single interface (<a href="Ash.html#bulk_destroy/4"><code class="inline">Ash.bulk_destroy/4</code></a>) is that the caller doesn't need to change based on the performance implications of the action.</p><blockquote><h3 id="check-the-docs" class="warning section-heading">
  <a href="#check-the-docs" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Check the docs!</span>
</h3>
<p>Make sure to thoroughly read and understand the documentation in <a href="Ash.html#bulk_destroy/4"><code class="inline">Ash.bulk_destroy/4</code></a> before using. Read each option and note the default values. By default, bulk destroys don't return records or errors, and don't emit notifications.</p></blockquote><h3 id="destroying-records" class="section-heading">
  <a href="#destroying-records" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Destroying records</span>
</h3>
<p>If you provide an enumerable of records, they will be destroyed in batches. For example:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Ash</span><span class="o">.</span><span class="n">bulk_destroy</span><span class="p" data-group-id="4216104316-1">(</span><span class="p" data-group-id="4216104316-2">[</span><span class="p" data-group-id="4216104316-3">%</span><span class="nc" data-group-id="4216104316-3">Ticket</span><span class="p" data-group-id="4216104316-3">{</span><span class="p" data-group-id="4216104316-3">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4216104316-4">%</span><span class="nc" data-group-id="4216104316-4">Ticket</span><span class="p" data-group-id="4216104316-4">{</span><span class="p" data-group-id="4216104316-4">}</span><span class="p" data-group-id="4216104316-2">]</span><span class="p">,</span><span class="w"> </span><span class="ss">:destroy</span><span class="p" data-group-id="4216104316-1">)</span></code></pre><h3 id="destroying" class="section-heading">
  <a href="#destroying" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Destroying</span>
</h3>
<h2 id="running-the-destroy-action" class="section-heading">
  <a href="#running-the-destroy-action" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Running the Destroy Action</span>
</h2>
<p>All actions are run in a transaction if the data layer supports it. You can opt out of this behavior by supplying <code class="inline">transaction?: false</code> when creating the action. When an action is being run in a transaction, all steps inside of it are serialized because transactions cannot be split across processes.</p><ul><li>Authorization is performed on the changes</li><li>A before action hook is added to set up belongs_to relationships that are managed. This means potentially creating/modifying the destination of the relationship, and then changing the <code class="inline">destination_attribute</code> of the relationship.</li><li><code class="inline">before_transaction</code> and <code class="inline">around_transaction</code> hooks are called (<a href="Ash.Changeset.html#before_transaction/2"><code class="inline">Ash.Changeset.before_transaction/2</code></a>). Keep in mind, any validations that are marked as <code class="inline">before_action? true</code> (or all global validations if your action has <code class="inline">delay_global_validations? true</code>) will not have happened at this point.</li><li>A transaction is opened if the action is configured for it (by default they are) and the data layer supports transactions</li><li><code class="inline">before_action</code> hooks are performed in order</li><li>The main action is sent to the data layer</li><li><code class="inline">after_action</code> hooks are performed in order</li><li>Non-belongs-to relationships are managed, creating/updating/destroying related records.</li><li>The transaction is closed, if one was opened</li><li><code class="inline">after_transaction</code> hooks are invoked with the result of the transaction (even if it was an error)</li></ul>
</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="update-actions.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Update Actions
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="generic-actions.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Generic Actions
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/ash/3.4.8" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/ash/3.4.8">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/ash/3.4.8/show/documentation/topics/actions/destroy-actions.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="ash.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.34.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
