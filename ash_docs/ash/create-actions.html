<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.34.2">
    <meta name="project" content="ash v3.4.8">


    <title>Create Actions — ash v3.4.8</title>
    <link rel="stylesheet" href="dist/html-elixir-F2VRIOKR.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-K7URE6B4.js"></script>
    <script src="dist/sidebar_items-370365CE.js"></script>
    <script src="docs_config.js"></script>
    <script async src="dist/html-YIPIRHGU.js"></script>
<style>
  .livebook-badge-container + pre {
    display: none;
  }
</style>
<script>
  if (location.hostname === "hexdocs.pm") {
    var script = document.createElement("script");
    script.src = "https://plausible.io/js/script.js";
    script.setAttribute("defer", "defer")
    script.setAttribute("data-domain", "ashhexdocs")
    document.head.appendChild(script);
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad: true})</script>

  </head>
  <body data-type="extras" class="page-extra">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://github.com/ash-project/ash" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="ash" />
        </a>

      <div>
        <a href="https://github.com/ash-project/ash" class="sidebar-projectName" translate="no">
ash
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v3.4.8
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
GUIDES
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


        <li>
          <button id="tasks-list-tab-button" role="tab" data-type="tasks" aria-controls="tasks-tab-panel" aria-selected="false" tabindex="-1">
            <span translate="no">Mix</span> Tasks
          </button>
        </li>

    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


    <div id="tasks-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="tasks-list-tab-button" hidden>
      <ul id="tasks-full-list" class="full-list"></ul>
    </div>

</nav>

<main class="content">
  <output role="status" id="toast"></output>

  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of ash</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search">
            <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <h1>

      <a href="https://github.com/ash-project/ash/blob/v3.4.8/documentation/topics/actions/create-actions.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>


    <span>Create Actions</span>
  </h1>

<p>Create actions are used to create new records in the data layer. For example:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># on a ticket resource</span><span class="w">
</span><span class="n">create</span><span class="w"> </span><span class="ss">:open</span><span class="w"> </span><span class="k" data-group-id="6821782579-1">do</span><span class="w">
  </span><span class="n">accept</span><span class="w"> </span><span class="p" data-group-id="6821782579-2">[</span><span class="ss">:title</span><span class="p" data-group-id="6821782579-2">]</span><span class="w">
  </span><span class="n">change</span><span class="w"> </span><span class="n">set_attribute</span><span class="p" data-group-id="6821782579-3">(</span><span class="ss">:status</span><span class="p">,</span><span class="w"> </span><span class="ss">:open</span><span class="p" data-group-id="6821782579-3">)</span><span class="w">
</span><span class="k" data-group-id="6821782579-1">end</span></code></pre><p>Here we have a create action called <code class="inline">:open</code> that allows setting the <code class="inline">title</code>, and sets the <code class="inline">status</code> to <code class="inline">:open</code>. It could be called like so:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Ticket</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">for_create</span><span class="p" data-group-id="9279994941-1">(</span><span class="ss">:open</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9279994941-2">%{</span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Need help!&quot;</span><span class="p" data-group-id="9279994941-2">}</span><span class="p" data-group-id="9279994941-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="9279994941-3">(</span><span class="p" data-group-id="9279994941-3">)</span></code></pre><p>See the <a href="code-interfaces.html">Code Interface guide</a> for creating an interface to call the action more elegantly, like so:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Support</span><span class="o">.</span><span class="n">open_ticket!</span><span class="p" data-group-id="6558269804-1">(</span><span class="s">&quot;Need help!&quot;</span><span class="p" data-group-id="6558269804-1">)</span></code></pre><h2 id="bulk-creates" class="section-heading">
  <a href="#bulk-creates" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Bulk creates</span>
</h2>
<p>Bulk creates take a list or stream of inputs for a given action, and batches calls to the underlying data layer.</p><p>Given our example above, you could call <code class="inline">Ash.bulk_create</code> like so:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Ash</span><span class="o">.</span><span class="n">bulk_create</span><span class="p" data-group-id="6336432092-1">(</span><span class="p" data-group-id="6336432092-2">[</span><span class="p" data-group-id="6336432092-3">%{</span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Foo&quot;</span><span class="p" data-group-id="6336432092-3">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6336432092-4">%{</span><span class="ss">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Bar&quot;</span><span class="p" data-group-id="6336432092-4">}</span><span class="p" data-group-id="6336432092-2">]</span><span class="p">,</span><span class="w"> </span><span class="nc">Ticket</span><span class="p">,</span><span class="w"> </span><span class="ss">:open</span><span class="p" data-group-id="6336432092-1">)</span></code></pre><blockquote><h3 id="check-the-docs" class="warning section-heading">
  <a href="#check-the-docs" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Check the docs!</span>
</h3>
<p>Make sure to thoroughly read and understand the documentation in <a href="Ash.html#bulk_create/4"><code class="inline">Ash.bulk_create/4</code></a> before using. Read each option and note the default values. By default, bulk creates don't return records or errors, and don't emit notifications.</p></blockquote><h2 id="performance" class="section-heading">
  <a href="#performance" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Performance</span>
</h2>
<p>Generally speaking, all regular Ash create actions are compatible (or can be made to be compatible) with bulk create actions. However, there are some important considerations.</p><ul><li><p><a href="Ash.Resource.Change.html"><code class="inline">Ash.Resource.Change</code></a> modules can be optimized for bulk actions by implementing <code class="inline">batch_change/3</code>, <code class="inline">before_batch/3</code> and <code class="inline">after_batch/3</code>. If you implement <code class="inline">batch_change/3</code>, the <code class="inline">change</code> function will no longer be called, and you should swap any behavior implemented with <code class="inline">before_action</code> and <code class="inline">after_action</code> hooks to logic in the <code class="inline">before_batch</code> and <code class="inline">after_batch</code> callbacks.</p></li><li><p>Actions that reference arguments in changes, i.e <code class="inline">change set_attribute(:attr, ^arg(:arg))</code> will prevent us from using the <code class="inline">batch_change/3</code> behavior. This is usually not a problem, for instance that change is lightweight and would not benefit from being optimized with <code class="inline">batch_change/3</code></p></li><li><p>If your action uses <code class="inline">after_action</code> hooks, or has <code class="inline">after_batch/3</code> logic defined for any of its changes, then we <em>must</em> ask the data layer to return the records it inserted. Again, this is not generally a problem because we throw away the results of each batch by default. If you are using <code class="inline">return_records?: true</code> then you are already requesting all of the results anyway.</p></li></ul><h2 id="returning-a-stream" class="section-heading">
  <a href="#returning-a-stream" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Returning a Stream</span>
</h2>
<p>Returning a stream allows you to work with a bulk action as an Elixir Stream. For example:</p><pre><code class="makeup elixir" translate="no"><span class="n">input_stream</span><span class="p" data-group-id="4667062509-1">(</span><span class="p" data-group-id="4667062509-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">bulk_create</span><span class="p" data-group-id="4667062509-2">(</span><span class="nc">Resource</span><span class="p">,</span><span class="w"> </span><span class="ss">:action</span><span class="p">,</span><span class="w"> </span><span class="ss">return_stream?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">return_records?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4667062509-2">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">map</span><span class="p" data-group-id="4667062509-3">(</span><span class="k" data-group-id="4667062509-4">fn</span><span class="w"> </span><span class="p" data-group-id="4667062509-5">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="4667062509-5">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="c1"># process results</span><span class="w">
  </span><span class="p" data-group-id="4667062509-6">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p" data-group-id="4667062509-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="c1"># process errors</span><span class="w">
</span><span class="k" data-group-id="4667062509-4">end</span><span class="p" data-group-id="4667062509-3">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p" data-group-id="4667062509-7">(</span><span class="p" data-group-id="4667062509-8">%{</span><span class="p" data-group-id="4667062509-8">}</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="4667062509-9">fn</span><span class="w"> </span><span class="p" data-group-id="4667062509-10">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p" data-group-id="4667062509-10">}</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
   </span><span class="c1"># process results</span><span class="w">
   </span><span class="p" data-group-id="4667062509-11">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p" data-group-id="4667062509-11">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
   </span><span class="c1"># process errors</span><span class="w">
</span><span class="k" data-group-id="4667062509-9">end</span><span class="p" data-group-id="4667062509-7">)</span></code></pre><blockquote><h3 id="be-careful-with-streams" class="warning section-heading">
  <a href="#be-careful-with-streams" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Be careful with streams</span>
</h3>
<p>Because streams are lazily evaluated, if you were to do something like this:</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="6861488657-1">[</span><span class="n">input1</span><span class="p">,</span><span class="w"> </span><span class="n">input2</span><span class="p">,</span><span class="w"> </span><span class="n">...</span><span class="p" data-group-id="6861488657-1">]</span><span class="w"> </span><span class="c1"># has 300 things in it</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">bulk_create</span><span class="p" data-group-id="6861488657-2">(</span><span class="w">
  </span><span class="nc">Resource</span><span class="p">,</span><span class="w">
  </span><span class="ss">:action</span><span class="p">,</span><span class="w">
  </span><span class="ss">return_stream?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w">
  </span><span class="ss">return_records?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w">
  </span><span class="ss">batch_size</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="c1">#  default is 100</span><span class="w">
</span><span class="p" data-group-id="6861488657-2">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">take</span><span class="p" data-group-id="6861488657-3">(</span><span class="mi">150</span><span class="p" data-group-id="6861488657-3">)</span><span class="w"> </span><span class="c1"># stream has 300, but we only take 150</span></code></pre><p>What would happen is that we would insert 200 records. The stream would end after we process the first two batches of 100. Be sure you aren't using things like <code class="inline">Stream.take</code> or <code class="inline">Enum.take</code> to limit the amount of things pulled from the stream, unless you actually want to limit the number of records created.</p></blockquote><h2 id="upserts" class="section-heading">
  <a href="#upserts" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Upserts</span>
</h2>
<p>Upserting is the process of &quot;creating or updating&quot; a record, modeled with a single simple create. Both bulk creates and regular creates support upserts. Upserts can be declared in the action, like so:</p><pre><code class="makeup elixir" translate="no"><span class="n">create</span><span class="w"> </span><span class="ss">:create_user</span><span class="w"> </span><span class="k" data-group-id="2058992452-1">do</span><span class="w">
  </span><span class="n">accept</span><span class="w"> </span><span class="p" data-group-id="2058992452-2">[</span><span class="ss">:email</span><span class="p" data-group-id="2058992452-2">]</span><span class="w">
  </span><span class="n">upsert?</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="n">upsert_identity</span><span class="w"> </span><span class="ss">:unique_email</span><span class="w">
</span><span class="k" data-group-id="2058992452-1">end</span></code></pre><p>Or they can be done with options when calling the create action.</p><pre><code class="makeup elixir" translate="no"><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="7106751830-1">(</span><span class="n">changeset</span><span class="p">,</span><span class="w"> </span><span class="ss">upsert?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="ss">upsert_identity</span><span class="p">:</span><span class="w"> </span><span class="ss">:unique_email</span><span class="p" data-group-id="7106751830-1">)</span></code></pre><blockquote><h3 id="upserts-do-not-use-an-update-action" class="warning section-heading">
  <a href="#upserts-do-not-use-an-update-action" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Upserts do not use an update action</span>
</h3>
<p>While an upsert is conceptually a &quot;create or update&quot; operation, it does not result in an update action being called. The data layer contains the upsert implementation. This means that if you have things like global changes that are only run on update, they will not be run on upserts that result in an update. Additionally, notifications for updates will not be emitted from upserts.</p></blockquote><h3 id="atomic-updates" class="section-heading">
  <a href="#atomic-updates" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Atomic Updates</span>
</h3>
<p>Upserts support atomic updates. These atomic updates <em>do not apply to the data being created</em>. They are only applied in the case of an update. For example:</p><pre><code class="makeup elixir" translate="no"><span class="n">create</span><span class="w"> </span><span class="ss">:create_game</span><span class="w"> </span><span class="k" data-group-id="2216276283-1">do</span><span class="w">
  </span><span class="n">accept</span><span class="w"> </span><span class="p" data-group-id="2216276283-2">[</span><span class="ss">:identifier</span><span class="p" data-group-id="2216276283-2">]</span><span class="w">
  </span><span class="n">upsert?</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="n">upsert_identity</span><span class="w"> </span><span class="ss">:identifier</span><span class="w">
  </span><span class="n">change</span><span class="w"> </span><span class="n">set_attribute</span><span class="p" data-group-id="2216276283-3">(</span><span class="ss">:score</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="2216276283-3">)</span><span class="w">
  </span><span class="n">change</span><span class="w"> </span><span class="n">atomic_update</span><span class="p" data-group-id="2216276283-4">(</span><span class="ss">:score</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="2216276283-5">(</span><span class="n">score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2216276283-5">)</span><span class="p" data-group-id="2216276283-4">)</span><span class="w">
</span><span class="k" data-group-id="2216276283-1">end</span></code></pre><p>This will result in creating a game with a score of 0, and if the game already exists, it will increment the score by 1.</p><p>For information on options configured in the action, see <code class="inline"><a href="dsl-ash-resource.html#actions-create">Ash.Resource.Dsl.actions.create</a></code>.
For information on options when calling the action, see <a href="Ash.html#create/2"><code class="inline">Ash.create/2</code></a>.</p><h2 id="what-happens-when-you-run-a-create-action" class="section-heading">
  <a href="#what-happens-when-you-run-a-create-action" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">What happens when you run a create Action</span>
</h2>
<p>All actions are run in a transaction if the data layer supports it. You can opt out of this behavior by supplying <code class="inline">transaction?: false</code> when creating the action. When an action is being run in a transaction, all steps inside of it are serialized because transactions cannot be split across processes.</p><ul><li>Authorization is performed on the changes</li><li>A before action hook is added to set up belongs_to relationships that are managed. This means potentially creating/modifying the destination of the relationship, and then changing the <code class="inline">destination_attribute</code> of the relationship.</li><li><code class="inline">before_transaction</code> and <code class="inline">around_transaction</code> hooks are called (<a href="Ash.Changeset.html#before_transaction/2"><code class="inline">Ash.Changeset.before_transaction/2</code></a>). Keep in mind, any validations that are marked as <code class="inline">before_action? true</code> (or all global validations if your action has <code class="inline">delay_global_validations? true</code>) will not have happened at this point.</li><li>A transaction is opened if the action is configured for it (by default they are) and the data layer supports transactions</li><li><code class="inline">before_action</code> hooks are performed in order</li><li>The main action is sent to the data layer</li><li><code class="inline">after_action</code> hooks are performed in order</li><li>Non-belongs-to relationships are managed, creating/updating/destroying related records.</li><li>The transaction is closed, if one was opened</li><li><code class="inline">after_transaction</code> hooks are invoked with the result of the transaction (even if it was an error)</li></ul>
</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="read-actions.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Read Actions
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="update-actions.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Update Actions
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/ash/3.4.8" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/ash/3.4.8">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/ash/3.4.8/show/documentation/topics/actions/create-actions.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="ash.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.34.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
