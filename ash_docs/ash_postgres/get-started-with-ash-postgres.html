<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.34.2">
    <meta name="project" content="ash_postgres v2.3.1">


    <title>Get Started With Postgres — ash_postgres v2.3.1</title>
    <link rel="stylesheet" href="dist/html-elixir-P45HOAC7.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-K7URE6B4.js"></script>
    <script src="dist/sidebar_items-59AEB2F8.js"></script>
    <script src="docs_config.js"></script>
    <script async src="dist/html-K6B4O7EW.js"></script>
<script>
  if (location.hostname === "hexdocs.pm") {
    var script = document.createElement("script");
    script.src = "https://plausible.io/js/script.js";
    script.setAttribute("defer", "defer")
    script.setAttribute("data-domain", "ashhexdocs")
    document.head.appendChild(script);
  }
</script>

  </head>
  <body data-type="extras" class="page-extra">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="https://ash-hq.org" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="ash_postgres" />
        </a>

      <div>
        <a href="https://ash-hq.org" class="sidebar-projectName" translate="no">
ash_postgres
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v2.3.1
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
Pages
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


        <li>
          <button id="tasks-list-tab-button" role="tab" data-type="tasks" aria-controls="tasks-tab-panel" aria-selected="false" tabindex="-1">
            <span translate="no">Mix</span> Tasks
          </button>
        </li>

    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


    <div id="tasks-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="tasks-list-tab-button" hidden>
      <ul id="tasks-full-list" class="full-list"></ul>
    </div>

</nav>

<main class="content">
  <output role="status" id="toast"></output>

  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of ash_postgres</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search">
            <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <h1>

      <a href="https://github.com/ash-project/ash_postgres/blob/v2.3.1/documentation/tutorials/get-started-with-ash-postgres.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>


    <span>Get Started With Postgres</span>
  </h1>

<h2 id="installation" class="section-heading">
  <a href="#installation" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Installation</span>
</h2>
<p>We recommend <a href="https://www.postgresql.org/docs/16/index.html">reading up on postgresql</a> if you haven't.</p><ul><li><a href="https://www.postgresql.org/download/">Postgres must be installed</a> with a sufficiently permissive user</li></ul><!-- tabs-open --><h3 id="using-igniter-recommended" class="section-heading">
  <a href="#using-igniter-recommended" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Using Igniter (recommended)</span>
</h3>
<pre><code class="makeup sh" translate="no"><span class="">mix igniter.install ash_postgres
</span></code></pre><h3 id="manually" class="section-heading">
  <a href="#manually" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Manually</span>
</h3>
<h4>Add AshPostgres</h4><p>Add the <code class="inline">:ash_postgres</code> dependency to your application</p><p><code class="inline">{:ash_postgres, &quot;~&gt; 2.0.0&quot;}</code></p><p>Add <code class="inline">:ash_postgres</code> to your <code class="inline">.formatter.exs</code> file</p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="5086602829-1">[</span><span class="w">
  </span><span class="c1"># import the formatter rules from `:ash_postgres`</span><span class="w">
  </span><span class="ss">import_deps</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5086602829-2">[</span><span class="n">...</span><span class="p">,</span><span class="w"> </span><span class="ss">:ash_postgres</span><span class="p" data-group-id="5086602829-2">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">inputs</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5086602829-3">[</span><span class="n">...</span><span class="p" data-group-id="5086602829-3">]</span><span class="w">
</span><span class="p" data-group-id="5086602829-1">]</span></code></pre><h4>Create and configure your Repo</h4><p>Create <code class="inline">lib/helpdesk/repo.ex</code> with the following contents. <a href="AshPostgres.Repo.html"><code class="inline">AshPostgres.Repo</code></a> is a thin wrapper around <a href="https://hexdocs.pm/ecto/3.12.2/Ecto.Repo.html"><code class="inline">Ecto.Repo</code></a>, so see their documentation for how to use it if you need to use it directly. For standard Ash usage, all you will need to do is configure your resources to use your repo.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in lib/helpdesk/repo.ex</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Helpdesk.Repo</span><span class="w"> </span><span class="k" data-group-id="9078413590-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">AshPostgres.Repo</span><span class="p">,</span><span class="w"> </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:helpdesk</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">installed_extensions</span><span class="w"> </span><span class="k" data-group-id="9078413590-2">do</span><span class="w">
    </span><span class="c1"># Ash installs some functions that it needs to run the</span><span class="w">
    </span><span class="c1"># first time you generate migrations.</span><span class="w">
    </span><span class="p" data-group-id="9078413590-3">[</span><span class="s">&quot;ash-functions&quot;</span><span class="p" data-group-id="9078413590-3">]</span><span class="w">
  </span><span class="k" data-group-id="9078413590-2">end</span><span class="w">
</span><span class="k" data-group-id="9078413590-1">end</span></code></pre><p>Next we will need to create configuration files for various environments. Run the following to create the configuration files we need.</p><pre><code class="makeup bash" translate="no"><span class="">mkdir -p config
</span><span class="">touch config/config.exs
</span><span class="">touch config/dev.exs
</span><span class="">touch config/runtime.exs
</span><span class="">touch config/test.exs
</span></code></pre><p>Place the following contents in those files, ensuring that the credentials match the user you created for your database. For most conventional installations this will work out of the box. If you've followed other guides before this one, they may have had you create these files already, so just make sure these contents are there.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in config/config.exs</span><span class="w">
</span><span class="kn">import</span><span class="w"> </span><span class="nc">Config</span><span class="w">

</span><span class="c1"># This should already have been added in the first</span><span class="w">
</span><span class="c1"># getting started guide</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:helpdesk</span><span class="p">,</span><span class="w">
  </span><span class="ss">ash_domains</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9773286616-1">[</span><span class="nc">Helpdesk.Support</span><span class="p" data-group-id="9773286616-1">]</span><span class="w">

</span><span class="n">config</span><span class="w"> </span><span class="ss">:helpdesk</span><span class="p">,</span><span class="w">
  </span><span class="ss">ecto_repos</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9773286616-2">[</span><span class="nc">Helpdesk.Repo</span><span class="p" data-group-id="9773286616-2">]</span><span class="w">

</span><span class="c1"># Import environment specific config. This must remain at the bottom</span><span class="w">
</span><span class="c1"># of this file so it overrides the configuration defined above.</span><span class="w">
</span><span class="n">import_config</span><span class="w"> </span><span class="s">&quot;</span><span class="si" data-group-id="9773286616-3">#{</span><span class="n">config_env</span><span class="p" data-group-id="9773286616-4">(</span><span class="p" data-group-id="9773286616-4">)</span><span class="si" data-group-id="9773286616-3">}</span><span class="s">.exs&quot;</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># in config/dev.exs</span><span class="w">

</span><span class="kn">import</span><span class="w"> </span><span class="nc">Config</span><span class="w">

</span><span class="c1"># Configure your database</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:helpdesk</span><span class="p">,</span><span class="w"> </span><span class="nc">Helpdesk.Repo</span><span class="p">,</span><span class="w">
  </span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;postgres&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;postgres&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">hostname</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">database</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;helpdesk_dev&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">port</span><span class="p">:</span><span class="w"> </span><span class="mi">5432</span><span class="p">,</span><span class="w">
  </span><span class="ss">show_sensitive_data_on_connection_error</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w">
  </span><span class="ss">pool_size</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># in config/runtime.exs</span><span class="w">

</span><span class="kn">import</span><span class="w"> </span><span class="nc">Config</span><span class="w">

</span><span class="k">if</span><span class="w"> </span><span class="n">config_env</span><span class="p" data-group-id="4073198646-1">(</span><span class="p" data-group-id="4073198646-1">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:prod</span><span class="w"> </span><span class="k" data-group-id="4073198646-2">do</span><span class="w">
  </span><span class="n">database_url</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="4073198646-3">(</span><span class="s">&quot;DATABASE_URL&quot;</span><span class="p" data-group-id="4073198646-3">)</span><span class="w"> </span><span class="o">||</span><span class="w">
      </span><span class="k">raise</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
      environment variable DATABASE_URL is missing.
      For example: ecto://USER:PASS@HOST/DATABASE
      &quot;&quot;&quot;</span><span class="w">

  </span><span class="n">config</span><span class="w"> </span><span class="ss">:helpdesk</span><span class="p">,</span><span class="w"> </span><span class="nc">Helpdesk.Repo</span><span class="p">,</span><span class="w">
    </span><span class="ss">url</span><span class="p">:</span><span class="w"> </span><span class="n">database_url</span><span class="p">,</span><span class="w">
    </span><span class="ss">pool_size</span><span class="p">:</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">to_integer</span><span class="p" data-group-id="4073198646-4">(</span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="4073198646-5">(</span><span class="s">&quot;POOL_SIZE&quot;</span><span class="p" data-group-id="4073198646-5">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">&quot;10&quot;</span><span class="p" data-group-id="4073198646-4">)</span><span class="w">
</span><span class="k" data-group-id="4073198646-2">end</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># in config/test.exs</span><span class="w">

</span><span class="kn">import</span><span class="w"> </span><span class="nc">Config</span><span class="w">

</span><span class="c1"># Configure your database</span><span class="w">
</span><span class="c1">#</span><span class="w">
</span><span class="c1"># The MIX_TEST_PARTITION environment variable can be used</span><span class="w">
</span><span class="c1"># to provide built-in test partitioning in CI environment.</span><span class="w">
</span><span class="c1"># Run `mix help test` for more information.</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:helpdesk</span><span class="p">,</span><span class="w"> </span><span class="nc">Helpdesk.Repo</span><span class="p">,</span><span class="w">
  </span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;postgres&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;postgres&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">hostname</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">database</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;helpdesk_test</span><span class="si" data-group-id="8490848265-1">#{</span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="8490848265-2">(</span><span class="s">&quot;MIX_TEST_PARTITION&quot;</span><span class="p" data-group-id="8490848265-2">)</span><span class="si" data-group-id="8490848265-1">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">pool</span><span class="p">:</span><span class="w"> </span><span class="nc">Ecto.Adapters.SQL.Sandbox</span><span class="p">,</span><span class="w">
  </span><span class="ss">pool_size</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span></code></pre><p>And finally, add the repo to your application</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in lib/helpdesk/application.ex</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start</span><span class="p" data-group-id="3044432085-1">(</span><span class="c">_type</span><span class="p">,</span><span class="w"> </span><span class="c">_args</span><span class="p" data-group-id="3044432085-1">)</span><span class="w"> </span><span class="k" data-group-id="3044432085-2">do</span><span class="w">
    </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="3044432085-3">[</span><span class="w">
      </span><span class="c1"># Starts a worker by calling: Helpdesk.Worker.start_link(arg)</span><span class="w">
      </span><span class="c1"># {Helpdesk.Worker, arg}</span><span class="w">
      </span><span class="nc">Helpdesk.Repo</span><span class="w">
    </span><span class="p" data-group-id="3044432085-3">]</span><span class="w">

    </span><span class="n">...</span></code></pre><h4>Add AshPostgres to our resources</h4><p>Now we can add the data layer to our resources. The basic configuration for a resource requires the <code class="inline"><a href="https://hexdocs.pm/ash_postgres/dsl-ashpostgres.html#postgres-table">AshPostgres.postgres.table</a></code> and the <code class="inline"><a href="https://hexdocs.pm/ash_postgres/dsl-ashpostgres.html#postgres-repo">AshPostgres.postgres.repo</a></code>.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in lib/helpdesk/support/ticket.ex</span><span class="w">

  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Helpdesk.Support</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">AshPostgres.DataLayer</span><span class="w">

  </span><span class="n">postgres</span><span class="w"> </span><span class="k" data-group-id="4466302832-1">do</span><span class="w">
    </span><span class="n">table</span><span class="w"> </span><span class="s">&quot;tickets&quot;</span><span class="w">
    </span><span class="n">repo</span><span class="w"> </span><span class="nc">Helpdesk.Repo</span><span class="w">
  </span><span class="k" data-group-id="4466302832-1">end</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># in lib/helpdesk/support/representative.ex</span><span class="w">

  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Helpdesk.Support</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">AshPostgres.DataLayer</span><span class="w">

  </span><span class="n">postgres</span><span class="w"> </span><span class="k" data-group-id="0980321153-1">do</span><span class="w">
    </span><span class="n">table</span><span class="w"> </span><span class="s">&quot;representatives&quot;</span><span class="w">
    </span><span class="n">repo</span><span class="w"> </span><span class="nc">Helpdesk.Repo</span><span class="w">
  </span><span class="k" data-group-id="0980321153-1">end</span></code></pre><h4>Create the database and tables</h4><p>First, we'll create the database with <a href="https://hexdocs.pm/ash/3.4.4/Mix.Tasks.Ash.Setup.html"><code class="inline">mix ash.setup</code></a>.</p><p>Then we will generate database migrations. This is one of the many ways that AshPostgres can save time and reduce complexity.</p><pre><code class="makeup bash" translate="no"><span class="">mix ash.codegen add_tickets_and_representatives
</span></code></pre><p>If you are unfamiliar with database migrations, it is a good idea to get a rough idea of what they are and how they work. See the links at the bottom of this guide for more. A rough overview of how migrations work is that each time you need to make changes to your database, they are saved as small, reproducible scripts that can be applied in order. This is necessary both for clean deploys as well as working with multiple developers making changes to the structure of a single database.</p><p>Typically, you need to write these by hand. AshPostgres, however, will store snapshots each time you run the command to generate migrations and will figure out what migrations need to be created.</p><p>You should always look at the generated migrations to ensure that they look correct. Do so now by looking at the generated file in <code class="inline">priv/repo/migrations</code>.</p><p>Finally, we will create the local database and apply the generated migrations:</p><pre><code class="makeup bash" translate="no"><span class="">mix ash.setup
</span></code></pre><!-- tabs-close --><h3 id="try-it-out" class="section-heading">
  <a href="#try-it-out" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Try it out</span>
</h3>
<p>This is based on the <a href="https://hexdocs.pm/ash/getting_started.html">Getting Started</a> guide.
If you haven't already, you should read that first.</p><p>And now we're ready to try it out! Run the following in iex:</p><p>Lets create some data. We'll make a representative and give them some open and some closed tickets.</p><pre><code class="makeup elixir" translate="no"><span class="kn">require</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="w">

</span><span class="n">representative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6669553354-1">(</span><span class="w">
  </span><span class="nc">Helpdesk.Support.Representative</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">for_create</span><span class="p" data-group-id="6669553354-2">(</span><span class="ss">:create</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6669553354-3">%{</span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Joe Armstrong&quot;</span><span class="p" data-group-id="6669553354-3">}</span><span class="p" data-group-id="6669553354-2">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="6669553354-4">(</span><span class="p" data-group-id="6669553354-4">)</span><span class="w">
</span><span class="p" data-group-id="6669553354-1">)</span><span class="w">

</span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">5</span><span class="w"> </span><span class="k" data-group-id="6669553354-5">do</span><span class="w">
  </span><span class="n">ticket</span><span class="w"> </span><span class="o">=</span><span class="w">
    </span><span class="nc">Helpdesk.Support.Ticket</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">for_create</span><span class="p" data-group-id="6669553354-6">(</span><span class="ss">:open</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6669553354-7">%{</span><span class="ss">subject</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Issue </span><span class="si" data-group-id="6669553354-8">#{</span><span class="n">i</span><span class="si" data-group-id="6669553354-8">}</span><span class="s">&quot;</span><span class="p" data-group-id="6669553354-7">}</span><span class="p" data-group-id="6669553354-6">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Helpdesk.Support</span><span class="o">.</span><span class="n">create!</span><span class="p" data-group-id="6669553354-9">(</span><span class="p" data-group-id="6669553354-9">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">for_update</span><span class="p" data-group-id="6669553354-10">(</span><span class="ss">:assign</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6669553354-11">%{</span><span class="ss">representative_id</span><span class="p">:</span><span class="w"> </span><span class="n">representative</span><span class="o">.</span><span class="n">id</span><span class="p" data-group-id="6669553354-11">}</span><span class="p" data-group-id="6669553354-10">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">update!</span><span class="p" data-group-id="6669553354-12">(</span><span class="p" data-group-id="6669553354-12">)</span><span class="w">

  </span><span class="k">if</span><span class="w"> </span><span class="n">rem</span><span class="p" data-group-id="6669553354-13">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="6669553354-13">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k" data-group-id="6669553354-14">do</span><span class="w">
    </span><span class="n">ticket</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Changeset</span><span class="o">.</span><span class="n">for_update</span><span class="p" data-group-id="6669553354-15">(</span><span class="ss">:close</span><span class="p" data-group-id="6669553354-15">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">update!</span><span class="p" data-group-id="6669553354-16">(</span><span class="p" data-group-id="6669553354-16">)</span><span class="w">
  </span><span class="k" data-group-id="6669553354-14">end</span><span class="w">
</span><span class="k" data-group-id="6669553354-5">end</span></code></pre><p>And now we can read that data. You should see some debug logs that show the sql queries AshPostgres is generating.</p><pre><code class="makeup elixir" translate="no"><span class="kn">require</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="w">

</span><span class="c1"># Show the tickets where the subject contains &quot;2&quot;</span><span class="w">
</span><span class="nc">Helpdesk.Support.Ticket</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="9967944690-1">(</span><span class="n">contains</span><span class="p" data-group-id="9967944690-2">(</span><span class="n">subject</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;2&quot;</span><span class="p" data-group-id="9967944690-2">)</span><span class="p" data-group-id="9967944690-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="9967944690-3">(</span><span class="p" data-group-id="9967944690-3">)</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="kn">require</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="w">

</span><span class="c1"># Show the tickets that are closed and their subject does not contain &quot;4&quot;</span><span class="w">
</span><span class="nc">Helpdesk.Support.Ticket</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="3908311776-1">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:closed</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="p" data-group-id="3908311776-2">(</span><span class="n">contains</span><span class="p" data-group-id="3908311776-3">(</span><span class="n">subject</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;4&quot;</span><span class="p" data-group-id="3908311776-3">)</span><span class="p" data-group-id="3908311776-2">)</span><span class="p" data-group-id="3908311776-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="3908311776-4">(</span><span class="p" data-group-id="3908311776-4">)</span></code></pre><p>And, naturally, now that we are storing this in postgres, this database is persisted even if we stop/start our application. The nice thing, however, is that this was the <em>exact</em> same code that we ran against our resources when they were backed by ETS.</p><h3 id="aggregates" class="section-heading">
  <a href="#aggregates" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Aggregates</span>
</h3>
<p>Lets add some aggregates to our representatives resource. Aggregates are a tool to include grouped up data about relationships. You can read more about them in the <a href="https://hexdocs.pm/ash/aggregates.html">Aggregates guide</a>.</p><p>Here we will add an aggregate to easily query how many tickets are assigned to a representative, and how many of those tickets are open/closed.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in lib/helpdesk/support/representative.ex</span><span class="w">

  </span><span class="n">aggregates</span><span class="w"> </span><span class="k" data-group-id="5011386394-1">do</span><span class="w">
    </span><span class="c1"># The first argument here is the name of the aggregate</span><span class="w">
    </span><span class="c1"># The second is the relationship</span><span class="w">
    </span><span class="n">count</span><span class="w"> </span><span class="ss">:total_tickets</span><span class="p">,</span><span class="w"> </span><span class="ss">:tickets</span><span class="w">

    </span><span class="n">count</span><span class="w"> </span><span class="ss">:open_tickets</span><span class="p">,</span><span class="w"> </span><span class="ss">:tickets</span><span class="w"> </span><span class="k" data-group-id="5011386394-2">do</span><span class="w">
      </span><span class="c1"># Here we add a filter over the data that we are aggregating</span><span class="w">
      </span><span class="n">filter</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="5011386394-3">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:open</span><span class="p" data-group-id="5011386394-3">)</span><span class="w">
    </span><span class="k" data-group-id="5011386394-2">end</span><span class="w">

    </span><span class="n">count</span><span class="w"> </span><span class="ss">:closed_tickets</span><span class="p">,</span><span class="w"> </span><span class="ss">:tickets</span><span class="w"> </span><span class="k" data-group-id="5011386394-4">do</span><span class="w">
      </span><span class="n">filter</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="5011386394-5">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:closed</span><span class="p" data-group-id="5011386394-5">)</span><span class="w">
    </span><span class="k" data-group-id="5011386394-4">end</span><span class="w">
  </span><span class="k" data-group-id="5011386394-1">end</span></code></pre><p>Aggregates are powerful because they will be translated to SQL, and can be used in filters and sorts. For example:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in iex</span><span class="w">

</span><span class="kn">require</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="w">

</span><span class="nc">Helpdesk.Support.Representative</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="3806274536-1">(</span><span class="n">closed_tickets</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="3806274536-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">sort</span><span class="p" data-group-id="3806274536-2">(</span><span class="ss">closed_tickets</span><span class="p">:</span><span class="w"> </span><span class="ss">:desc</span><span class="p" data-group-id="3806274536-2">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="3806274536-3">(</span><span class="p" data-group-id="3806274536-3">)</span></code></pre><p>You can also load individual aggregates on demand after queries have already been run, and minimal SQL will be issued to run the aggregate.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in iex</span><span class="w">

</span><span class="kn">require</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="w">

</span><span class="n">representatives</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Helpdesk.Support</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="2455190951-1">(</span><span class="nc">Helpdesk.Support.Representative</span><span class="p" data-group-id="2455190951-1">)</span><span class="w">

</span><span class="nc">Ash</span><span class="o">.</span><span class="n">load!</span><span class="p" data-group-id="2455190951-2">(</span><span class="n">representatives</span><span class="p">,</span><span class="w"> </span><span class="ss">:open_tickets</span><span class="p" data-group-id="2455190951-2">)</span></code></pre><h3 id="calculations" class="section-heading">
  <a href="#calculations" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Calculations</span>
</h3>
<p>Calculations can be pushed down into SQL in the same way. Calculations are similar to aggregates, except they work on individual records. They can, however, refer to aggregates on the resource, which opens up powerful possibilities with very simple code.</p><p>For example, we can determine the percentage of tickets that are open:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in lib/helpdesk/support/representative.ex</span><span class="w">

  </span><span class="n">calculations</span><span class="w"> </span><span class="k" data-group-id="1287969066-1">do</span><span class="w">
    </span><span class="n">calculate</span><span class="w"> </span><span class="ss">:percent_open</span><span class="p">,</span><span class="w"> </span><span class="ss">:float</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p" data-group-id="1287969066-2">(</span><span class="n">open_tickets</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total_tickets</span><span class="p" data-group-id="1287969066-2">)</span><span class="w">
  </span><span class="k" data-group-id="1287969066-1">end</span></code></pre><p>Calculations can be loaded and used in the same way as aggregates.</p><pre><code class="makeup elixir" translate="no"><span class="kn">require</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="w">

</span><span class="nc">Helpdesk.Support.Representative</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">filter</span><span class="p" data-group-id="3364981464-1">(</span><span class="n">percent_open</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.25</span><span class="p" data-group-id="3364981464-1">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">sort</span><span class="p" data-group-id="3364981464-2">(</span><span class="ss">:percent_open</span><span class="p" data-group-id="3364981464-2">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash.Query</span><span class="o">.</span><span class="n">load</span><span class="p" data-group-id="3364981464-3">(</span><span class="ss">:percent_open</span><span class="p" data-group-id="3364981464-3">)</span><span class="w">
</span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Ash</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="3364981464-4">(</span><span class="p" data-group-id="3364981464-4">)</span></code></pre><h3 id="rich-configuration-options" class="section-heading">
  <a href="#rich-configuration-options" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Rich Configuration Options</span>
</h3>
<p>Take a look at the DSL documentation for more information on what you can configure. You can add check constraints, configure the behavior of foreign keys, use postgres schemas with Ash's <a href="https://hexdocs.pm/ash/multitenancy.html">multitenancy</a> feature, and more!</p><h3 id="what-next" class="section-heading">
  <a href="#what-next" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">What next?</span>
</h3>
<ul><li><p>Check out the data layer docs: <a href="AshPostgres.DataLayer.html"><code class="inline">AshPostgres.DataLayer</code></a></p></li><li><p><a href="https://hexdocs.pm/ecto/Ecto.html">Ecto's documentation</a>. AshPostgres (and much of Ash itself) is made possible by the amazing Ecto. If you find yourself looking for escape hatches when using Ash or ways to work directly with your database, you will want to know how Ecto works. Ash and AshPostgres intentionally do not hide Ecto, and in fact encourages its use whenever you need an escape hatch.</p></li><li><p><a href="https://www.postgresql.org/docs/">Postgres' documentation</a>. Although AshPostgres makes things a lot easier, you should understand the basics of postgres and SQL.</p></li><li><p><a href="https://hexdocs.pm/ecto_sql/Ecto.Migration.html">Ecto's Migration documentation</a> read more about migrations. Even with the ash_postgres migration generator, you will very likely need to modify your own migrations some day.</p></li></ul>
</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="readme.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Home
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="set-up-with-existing-database.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Setting AshPostgres up with an existing database
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/ash_postgres/2.3.1" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/ash_postgres/2.3.1">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/ash_postgres/2.3.1/show/documentation/tutorials/get-started-with-ash-postgres.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="ash_postgres.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.34.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
