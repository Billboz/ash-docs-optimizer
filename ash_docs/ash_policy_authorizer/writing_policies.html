<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.25.2">
    <meta name="project" content="ash_policy_authorizer v0.16.5">

    <title>Writing Policies — ash_policy_authorizer v0.16.5</title>
    <link rel="stylesheet" href="dist/elixir-37545fd2f35b96531434.css" />

    <script src="dist/sidebar_items-8be34f4263.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-f97730d45ef67f3e6188.js"></script>


  </head>
  <body data-type="extras">
    <script>

      try {
        if (localStorage.getItem('night-mode') === 'true') {
          document.body.classList.add('night-mode');
        }
      } catch (error) { }
    </script>

<div class="main">

<button class="sidebar-button sidebar-toggle">
  <span class="icon-menu" title="Collapse/expand sidebar"></span>
</button>

<section class="sidebar">
  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <span class="icon-search" aria-hidden="true" title="Submit search"></span>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <span class="icon-cross" aria-hidden="true" title="Cancel search"></span>
    </button>
    <label class="search-label">
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">
    <div class="sidebar-projectDetails">
      <a href="https://github.com/ash-project/ash_policy_authorizer" class="sidebar-projectName">
ash_policy_authorizer
      </a>
      <strong class="sidebar-projectVersion">
        v0.16.5
      </strong>
    </div>

      <a href="https://github.com/ash-project/ash_policy_authorizer">
        <img src="assets/logo.png" alt="ash_policy_authorizer" class="sidebar-projectImage">
      </a>

  </div>

  <ul class="sidebar-listNav">
    <li><a id="extras-list-link" href="#full-list">GUIDES</a></li>

      <li><a id="modules-list-link" href="#full-list">Modules</a></li>


  </ul>
  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>Writing Policies</h1><p>Policies determine what actions on a resource are permitted for a given actor.</p><p>You can specify an actor using the code api via the <code class="inline">actor</code> option, like so:</p><pre><code class="makeup elixir"><span class="nc">MyApp.MyApi</span><span class="o">.</span><span class="n">read</span><span class="p" data-group-id="8155705948-1">(</span><span class="nc">MyResource</span><span class="p">,</span><span class="w"> </span><span class="ss">actor</span><span class="p">:</span><span class="w"> </span><span class="n">current_user</span><span class="p" data-group-id="8155705948-1">)</span></code></pre><h2 id="important" class="section-heading">
  <a href="#important" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Important!
</h2>
<p>Before we jump into the guide, it is critical to understand that the policy code doesn't actually
<em>do</em> anything in the classic sense. It simply builds up a set of policies that are stored for use later.
The checker that reads those policies and authorizes requests may run all, some of, or none of your checks,
depending on the details of the request being authorized.</p><h2 id="guide" class="section-heading">
  <a href="#guide" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Guide
</h2>
<p>To see what checks are built-in, see <a href="AshPolicyAuthorizer.Check.BuiltInChecks.html"><code class="inline">AshPolicyAuthorizer.Check.BuiltInChecks</code></a></p><h3 id="the-simplest-policy" class="section-heading">
  <a href="#the-simplest-policy" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  The Simplest Policy
</h3>
<p>Lets start with the simplest policy set:</p><pre><code class="makeup elixir"><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="7756542406-1">do</span><span class="w">
  </span><span class="n">policy</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="7756542406-2">(</span><span class="p" data-group-id="7756542406-2">)</span><span class="w"> </span><span class="k" data-group-id="7756542406-3">do</span><span class="w">
    </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="7756542406-4">(</span><span class="p" data-group-id="7756542406-4">)</span><span class="w">
  </span><span class="k" data-group-id="7756542406-3">end</span><span class="w">
</span><span class="k" data-group-id="7756542406-1">end</span></code></pre><p>Here, we have a single policy. The first argument to <code class="inline">policy</code> is the &quot;condition&quot;. If the condition is true,
then the policy appolies to the request. If a given policy applies, then one of the checks inside the policy must authorize that policy. <em>Every policy that applies</em> to a given request must each be authorized for a request to be authorized.</p><p>Within this policy we have a single check, declared with <code class="inline">authorize_if</code>. Checks logically apply from top to bottom, based on their check type. In this case, we'd read the policy as &quot;this policy always applies, and authorizes always&quot;.</p><p>There are four check types, all of which do what they sound like they do:</p><ul><li><code class="inline">authorize_if</code> - if the check is true, the policy is authorized.</li><li><code class="inline">authorize_unless</code> - if the check is false, the policy is authorized.</li><li><code class="inline">forbid_if</code> - if the check is true, the policy is forbidden.</li><li><code class="inline">forbid_unless</code> - if the check is false, the policy is forbidden.</li></ul><p>In each case, if the policy is not authorized or forbidden, the flow moves to the next check.</p><h3 id="a-realistic-policy" class="section-heading">
  <a href="#a-realistic-policy" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  A realistic policy
</h3>
<p>In this example, we use some of the provided built in checks.</p><pre><code class="makeup elixir"><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="3794244000-1">do</span><span class="w">
  </span><span class="c1"># Anything you can use in a condition, you can use in a check, and vice-versa</span><span class="w">
  </span><span class="c1"># This policy applies if the actor is a super_user</span><span class="w">
  </span><span class="c1"># Addtionally, this policy is declared as a `bypass`. That means that this check is allowed to fail without</span><span class="w">
  </span><span class="c1"># failing the whole request, and that if this check *passes*, the entire request passes.</span><span class="w">
  </span><span class="n">bypass</span><span class="w"> </span><span class="n">actor_attribute_equals</span><span class="p" data-group-id="3794244000-2">(</span><span class="ss">:super_user</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="3794244000-2">)</span><span class="w"> </span><span class="k" data-group-id="3794244000-3">do</span><span class="w">
    </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="3794244000-4">(</span><span class="p" data-group-id="3794244000-4">)</span><span class="w">
  </span><span class="k" data-group-id="3794244000-3">end</span><span class="w">

  </span><span class="c1"># This will likely be a common occurrence. Specifically, policies that apply to all read actions</span><span class="w">
  </span><span class="n">policy</span><span class="w"> </span><span class="n">action_type</span><span class="p" data-group-id="3794244000-5">(</span><span class="ss">:read</span><span class="p" data-group-id="3794244000-5">)</span><span class="w"> </span><span class="k" data-group-id="3794244000-6">do</span><span class="w">
    </span><span class="c1"># unless the actor is an active user, forbid their request</span><span class="w">
    </span><span class="n">forbid_unless</span><span class="w"> </span><span class="n">actor_attribute_equals</span><span class="p" data-group-id="3794244000-7">(</span><span class="ss">:active</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="3794244000-7">)</span><span class="w">
    </span><span class="c1"># if the record is marked as public, authorize the request</span><span class="w">
    </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">attribute</span><span class="p" data-group-id="3794244000-8">(</span><span class="ss">:public</span><span class="p">,</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="3794244000-8">)</span><span class="w">
    </span><span class="c1"># if the actor is related to the data via that data&#39;s `owner` relationship, authorize the request</span><span class="w">
    </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">relates_to_actor_via</span><span class="p" data-group-id="3794244000-9">(</span><span class="ss">:owner</span><span class="p" data-group-id="3794244000-9">)</span><span class="w">
  </span><span class="k" data-group-id="3794244000-6">end</span><span class="w">
</span><span class="k" data-group-id="3794244000-1">end</span></code></pre><h3 id="access-type" class="section-heading">
  <a href="#access-type" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Access Type
</h3>
<p>The default access type is <code class="inline">:filter</code>. In most cases this will be all you need. In the example above, if a user made a request for all instances
of the resource, it wouldn't actually return a forbidden error. It simply attaches the appropriate filter to fetch data that the user can see.
If the actor attribute <code class="inline">active</code> was <code class="inline">false</code>, then the request <em>would</em> be forbidden (because there is no data for which they can pass this policy). However, if <code class="inline">active</code> is <code class="inline">true</code>, the authorizer would attach the following filter to the request:</p><pre><code class="makeup elixir"><span class="p" data-group-id="9348473974-1">[</span><span class="ss">or</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9348473974-2">[</span><span class="p" data-group-id="9348473974-3">[</span><span class="ss">public</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="9348473974-3">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9348473974-4">[</span><span class="ss">owner</span><span class="p">:</span><span class="w"> </span><span class="n">actor</span><span class="p" data-group-id="9348473974-5">(</span><span class="ss">:_primary_key</span><span class="p" data-group-id="9348473974-5">)</span><span class="p" data-group-id="9348473974-4">]</span><span class="p" data-group-id="9348473974-2">]</span><span class="p" data-group-id="9348473974-1">]</span></code></pre><p>To understand what <code class="inline">actor(:_primary_key)</code> means, see the Filter Templates section in <a href="https://hexdocs.pm/ash/1.50.14/Ash.Filter.html"><code class="inline">Ash.Filter</code></a></p><p>To change this behavior, use <code class="inline">access_type :strict</code>. With <code class="inline">access_type :strict</code> you will force the request to fail unless a filter was provided to yield the appropriate data. In this case, any filter that is a subset of the authorization filter would work. For example: <code class="inline">[public: true]</code>, or <code class="inline">[owner: [id: current_user.id]]</code>.</p><p>Additionally, some checks have more expensive components that can't be checked before the request is run. To enable those, use the <code class="inline">access_type :runtime</code>. This is stil relatively experimental, but this will attempt to run as much of your checks in a strict fashion, and attach as many things as filters as possible, before running the expensive portion of the checks (defined on the check as <a href="AshPolicyAuthorizer.Check.html#c:check/4"><code class="inline">AshPolicyAuthorizer.Check.check/4</code></a>)</p><h3 id="custom-checks" class="section-heading">
  <a href="#custom-checks" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  Custom checks
</h3>
<p>See <a href="AshPolicyAuthorizer.Check.html"><code class="inline">AshPolicyAuthorizer.Check</code></a> for more inforamtion on writing custom checks, which you will likely need at some point when the built in checks are insufficient</p><h3 id="more" class="section-heading">
  <a href="#more" class="hover-link"><span class="icon-link" aria-hidden="true"></span></a>
  More
</h3>
<p>More will need to be written, as questions arise.</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="api-reference.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
API Reference
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="policy_breakdowns.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Policy Breakdowns
        </span>
      </a>

  </div>
</div>

      <footer class="footer">

        <p>
          Find it on Hex:
          <a href="https://hex.pm/packages/ash_policy_authorizer/0.16.5" class="line footer-hex-package">Package</a>
          <a href="https://preview.hex.pm/preview/ash_policy_authorizer/0.16.5" class="line">Preview</a>

            <a href="https://preview.hex.pm/preview/ash_policy_authorizer/0.16.5/show/documentation/writing_policies.md">(current file)</a>

        </p>

        <p>
          <span class="line">
            Built using
            <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener">ExDoc</a> (v0.25.2) for the
            <a href="https://elixir-lang.org" title="Elixir" target="_blank">Elixir programming language</a>.
          </span>
          <span class="line">
            Designed by
            <a href="https://twitter.com/dignifiedquire" target="_blank" rel="noopener" title="@dignifiedquire">Friedel Ziegelmayer</a>.
          </span>
        </p>
        <p>

            <a href="api-reference.html" title="API reference" class="line footer-button">API Reference</a>

          <button class="line footer-button display-shortcuts-help">
            Display keyboard shortcuts
          </button>
          <button class="line footer-button night-mode-toggle">
            Toggle night mode
          </button>
          <button class="line footer-button display-quick-switch">
            Go to a HexDocs package
          </button>
          <button class="line footer-button tooltips-toggle">
            <span class="tooltips-option-disable">Disable tooltips</span>
            <span class="tooltips-option-enable">Enable tooltips</span>
          </button>
        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
