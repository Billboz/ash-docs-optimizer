<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.31.1">
    <meta name="project" content="ash_authentication_phoenix v2.1.1">


    <title>Getting Started Ash Authentication Phoenix — ash_authentication_phoenix v2.1.1</title>
    <link rel="stylesheet" href="dist/html-elixir-E7ZJOKRA.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-A7S2WMC7.js"></script>
    <script src="dist/sidebar_items-E069711B.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/html-GFE2JU6H.js"></script>

<script>
  if (location.hostname === "hexdocs.pm") {
    var script = document.createElement("script");
    script.src = "https://plausible.io/js/script.js";
    script.setAttribute("defer", "defer")
    script.setAttribute("data-domain", "ashhexdocs")
    document.head.appendChild(script);
  }
</script>

  </head>
  <body data-type="extras" class="page-extra">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<div class="background-layer"></div>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
ash_authentication_phoenix
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v2.1.1
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
Pages
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


</nav>

<main class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">
      <div class="top-search">
        <div class="search-settings">
          <form class="search-bar" action="search.html">
            <label class="search-label">
              <span class="sr-only">Search documentation of ash_authentication_phoenix</span>
              <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            </label>
            <button type="submit" class="search-button" aria-label="Submit Search">
              <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
            </button>
            <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
              <i class="ri-close-line ri-lg" title="Cancel search"></i>
            </button>
          </form>
          <div class="autocomplete">
          </div>
          <button class="icon-settings display-settings">
            <i class="ri-settings-3-line"></i>
            <span class="sr-only">Settings</span>
          </button>
        </div>

      </div>

<h1>

    <a href="https://github.com/team-alembic/ash_authentication_phoenix/blob/main/documentation/tutorials/get-started.md#L1" title="View Source" class="icon-action" rel="help">
      <i class="ri-code-s-slash-line" aria-hidden="true"></i>
      <span class="sr-only">View Source</span>
    </a>


  <span>Getting Started Ash Authentication Phoenix</span>
</h1>

<p>In this step-by-step tutorial we create a new empty <code class="inline">Example</code> Phoenix + Ash application which provides the functionality for authentication. For beginners it is the best to follow the tutorial in the given order. For more advanced users it is a good reference to pick and choose from.</p><p>We assumes that you have <a href="https://elixir-lang.org">Elixir</a> version 1.14.x (check with <code class="inline">elixir -v</code>) and Phoenix 1.7 (check with <code class="inline">mix phx.new --version</code>) installed. We also assume that you have a <a href="https://www.postgresql.org">PostgreSQL</a> database running which we use to persist the user data.</p><h2 id="green-field-phoenix-application" class="section-heading">
  <a href="#green-field-phoenix-application" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Green Field Phoenix Application</span>
</h2>
<p>We start with a new Phoenix application:</p><pre><code class="makeup bash" translate="no"><span class="gp unselectable">$ </span><span class="">mix phx.new example
</span><span class="gp unselectable">$ </span><span class="">cd example
</span></code></pre><h2 id="basic-ash-setup" class="section-heading">
  <a href="#basic-ash-setup" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Basic Ash Setup</span>
</h2>
<h3 id="application-dependencies" class="section-heading">
  <a href="#application-dependencies" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Application Dependencies</span>
</h3>
<p>We need to add the following dependencies. Use <code class="inline">mix hex.info dependency_name</code> to get the latest version of each dependency.</p><p><strong>mix.exs</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Example.MixProject</span><span class="w"> </span><span class="k" data-group-id="8465645237-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Mix.Project</span><span class="w">
  </span><span class="c1"># ...</span><span class="w">

    </span><span class="kd">defp</span><span class="w"> </span><span class="nf">deps</span><span class="w"> </span><span class="k" data-group-id="8465645237-2">do</span><span class="w">
    </span><span class="p" data-group-id="8465645237-3">[</span><span class="w">
      </span><span class="c1"># ...</span><span class="w">
      </span><span class="c1"># add these lines --&gt;</span><span class="w">
      </span><span class="p" data-group-id="8465645237-4">{</span><span class="ss">:ash</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; x.x&quot;</span><span class="p" data-group-id="8465645237-4">}</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="8465645237-5">{</span><span class="ss">:ash_authentication</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; x.x&quot;</span><span class="p" data-group-id="8465645237-5">}</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="8465645237-6">{</span><span class="ss">:ash_authentication_phoenix</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; x.x&quot;</span><span class="p" data-group-id="8465645237-6">}</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="8465645237-7">{</span><span class="ss">:ash_postgres</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; x.x&quot;</span><span class="p" data-group-id="8465645237-7">}</span><span class="p">,</span><span class="w">
      </span><span class="p" data-group-id="8465645237-8">{</span><span class="ss">:picosat_elixir</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; x.x&quot;</span><span class="p" data-group-id="8465645237-8">}</span><span class="w">
      </span><span class="c1"># &lt;-- add these lines</span><span class="w">
    </span><span class="p" data-group-id="8465645237-3">]</span><span class="w">
  </span><span class="k" data-group-id="8465645237-2">end</span><span class="w">
  </span><span class="c1"># ...</span></code></pre><p>Let's fetch everything:</p><pre><code class="makeup bash" translate="no"><span class="gp unselectable">$ </span><span class="">mix deps.get
</span></code></pre><blockquote><h3 id="picosat-installation-issues" class="info section-heading">
  <a href="#picosat-installation-issues" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Picosat installation issues?</span>
</h3>
<p>If you have trouble compiling <code class="inline">picosat_elixir</code>, then replace <code class="inline">{:picosat_elixir, &quot;~&gt; x.x&quot;}</code> with <code class="inline">{:simple_sat, &quot;~&gt; x.x&quot;}</code> to use a simpler (but mildly slower) solver. You can always switch back to <code class="inline">picosat_elixir</code> later once you're done with the tutorial.</p></blockquote><h3 id="formatter" class="section-heading">
  <a href="#formatter" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Formatter</span>
</h3>
<p>We can make our life easier and the code more consistent by adding formatters to the project. We will use <a href="https://hexdocs.pm/mix/Mix.Tasks.Format.html">Elixir's built-in formatter</a> for this.</p><p><strong>.formatter.exs</strong></p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="1637565590-1">[</span><span class="w">
  </span><span class="ss">import_deps</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1637565590-2">[</span><span class="w">
    </span><span class="ss">:phoenix</span><span class="p">,</span><span class="w">
    </span><span class="c1"># add these lines --&gt;</span><span class="w">
    </span><span class="ss">:ash</span><span class="p">,</span><span class="w">
    </span><span class="ss">:ash_authentication</span><span class="p">,</span><span class="w">
    </span><span class="ss">:ash_authentication_phoenix</span><span class="p">,</span><span class="w">
    </span><span class="ss">:ash_postgres</span><span class="w">
    </span><span class="c1"># &lt;-- add these lines</span><span class="w">
    </span><span class="p" data-group-id="1637565590-2">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">plugins</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1637565590-3">[</span><span class="nc">Phoenix.LiveView.HTMLFormatter</span><span class="p" data-group-id="1637565590-3">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">inputs</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1637565590-4">[</span><span class="s">&quot;*.{heex,ex,exs}&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;{config,lib,test}/**/*.{heex,ex,exs}&quot;</span><span class="p" data-group-id="1637565590-4">]</span><span class="w">
</span><span class="p" data-group-id="1637565590-1">]</span></code></pre><h3 id="tailwind" class="section-heading">
  <a href="#tailwind" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Tailwind</span>
</h3>
<p>If you plan on using our default <a href="https://tailwindcss.com/">Tailwind</a>-based
components without overriding them you will need to modify your
<code class="inline">assets/tailwind.config.js</code> to include the <code class="inline">ash_authentication_phoenix</code>
dependency:</p><p><strong>assets/tailwind.config.js</strong></p><pre><code class="javascript">// See the Tailwind configuration guide for advanced usage
// https://tailwindcss.com/docs/configuration

const plugin = require(&quot;tailwindcss/plugin&quot;);

module.exports = {
  content: [
    &quot;./js/**/*.js&quot;,
    &quot;../lib/*_web.ex&quot;,
    &quot;../lib/*_web/**/*.*ex&quot;,
    &quot;../deps/ash_authentication_phoenix/**/*.*ex&quot;, // &lt;-- Add this line
  ],
  theme: {
    extend: {
      colors: {
        brand: &quot;#FD4F00&quot;,
      },
    },
  },
  plugins: [
    require(&quot;@tailwindcss/forms&quot;),
    plugin(({ addVariant }) =&gt;
      addVariant(&quot;phx-no-feedback&quot;, [
        &quot;.phx-no-feedback&amp;&quot;,
        &quot;.phx-no-feedback &amp;&quot;,
      ]),
    ),
    plugin(({ addVariant }) =&gt;
      addVariant(&quot;phx-click-loading&quot;, [
        &quot;.phx-click-loading&amp;&quot;,
        &quot;.phx-click-loading &amp;&quot;,
      ]),
    ),
    plugin(({ addVariant }) =&gt;
      addVariant(&quot;phx-submit-loading&quot;, [
        &quot;.phx-submit-loading&amp;&quot;,
        &quot;.phx-submit-loading &amp;&quot;,
      ]),
    ),
    plugin(({ addVariant }) =&gt;
      addVariant(&quot;phx-change-loading&quot;, [
        &quot;.phx-change-loading&amp;&quot;,
        &quot;.phx-change-loading &amp;&quot;,
      ]),
    ),
  ],
};</code></pre><h2 id="ashpostgres-repo-setup" class="section-heading">
  <a href="#ashpostgres-repo-setup" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">AshPostgres.Repo Setup</span>
</h2>
<p>We use <a href="https://hexdocs.pm/ash_postgres/AshPostgres.html">AshPostgres</a> to handle the database tables for our application. We need to replace the content of the <code class="inline">Repo</code> module with the following code:</p><p><strong>lib/example/repo.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Example.Repo</span><span class="w"> </span><span class="k" data-group-id="7173792958-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">AshPostgres.Repo</span><span class="p">,</span><span class="w"> </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:example</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">installed_extensions</span><span class="w"> </span><span class="k" data-group-id="7173792958-2">do</span><span class="w">
    </span><span class="p" data-group-id="7173792958-3">[</span><span class="s">&quot;uuid-ossp&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;citext&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ash-functions&quot;</span><span class="p" data-group-id="7173792958-3">]</span><span class="w">
  </span><span class="k" data-group-id="7173792958-2">end</span><span class="w">
</span><span class="k" data-group-id="7173792958-1">end</span></code></pre><p>We have to configure the Repo in <code class="inline">config/config.exs</code>. While doing that we also configure other stuff which we need later.</p><p><strong>config/config.exs</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># ...</span><span class="w">

</span><span class="kn">import</span><span class="w"> </span><span class="nc">Config</span><span class="w">

</span><span class="c1"># add these lines --&gt;</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:example</span><span class="p">,</span><span class="w">
  </span><span class="ss">ash_domains</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3583538405-1">[</span><span class="nc">Example.Accounts</span><span class="p" data-group-id="3583538405-1">]</span><span class="w">
</span><span class="c1"># ...</span></code></pre><p>We need to add <a href="https://hexdocs.pm/ash_authentication/4.0.4/AshAuthentication.Supervisor.html"><code class="inline">AshAuthentication.Supervisor</code></a> to the supervision tree in <code class="inline">lib/example/application.ex</code>:</p><p><code class="inline">** lib/example/application.ex **</code></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Example.Application</span><span class="w"> </span><span class="k" data-group-id="7659135154-1">do</span><span class="w">
  </span><span class="c1"># ...</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start</span><span class="p" data-group-id="7659135154-2">(</span><span class="c">_type</span><span class="p">,</span><span class="w"> </span><span class="c">_args</span><span class="p" data-group-id="7659135154-2">)</span><span class="w"> </span><span class="k" data-group-id="7659135154-3">do</span><span class="w">
    </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7659135154-4">[</span><span class="w">
      </span><span class="c1"># ...</span><span class="w">
      </span><span class="c1"># add this line --&gt;</span><span class="w">
      </span><span class="p" data-group-id="7659135154-5">{</span><span class="nc">AshAuthentication.Supervisor</span><span class="p">,</span><span class="w"> </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:example</span><span class="p" data-group-id="7659135154-5">}</span><span class="w">
      </span><span class="c1"># &lt;-- add this line</span><span class="w">
    </span><span class="p" data-group-id="7659135154-4">]</span><span class="w">
  </span><span class="c1"># ...</span></code></pre><h2 id="accounts-domain-and-resources" class="section-heading">
  <a href="#accounts-domain-and-resources" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Accounts Domain and Resources</span>
</h2>
<p>We need to create an <code class="inline">Accounts</code> domain in our application to provide a <code class="inline">User</code> and a <code class="inline">Token</code> resource. Strictly speaking we don't need the <code class="inline">Token</code> resource for just the login with a password. But we'll need it later (e.g. for the password reset) so we just create it now while we are here.</p><p>Although we are using User in the example, you can name your resource anything you need, for instance Admin.
The <code class="inline">current_*</code> assign will be inferred from it. User will make <code class="inline">current_user</code> available, Admin will make <code class="inline">current_admin</code> available.</p><p>At the end we should have the following directory structure:</p><pre><code class="makeup bash" translate="no"><span class="">lib/example
</span><span class="">├── accounts
</span><span class="">|   ├── accounts.ex
</span><span class="">|   ├── secrets.ex
</span><span class="">│   ├── token.ex
</span><span class="">|   └── user.ex
</span><span class="">...
</span></code></pre><p><strong>lib/example/accounts/user.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Example.Accounts.User</span><span class="w"> </span><span class="k" data-group-id="3140262383-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Example.Accounts</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">AshPostgres.DataLayer</span><span class="p">,</span><span class="w">
    </span><span class="c1"># If using policies, enable the policy authorizer:</span><span class="w">
    </span><span class="c1"># authorizers: [Ash.Policy.Authorizer],</span><span class="w">
    </span><span class="ss">extensions</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3140262383-2">[</span><span class="nc">AshAuthentication</span><span class="p" data-group-id="3140262383-2">]</span><span class="w">

  </span><span class="n">attributes</span><span class="w"> </span><span class="k" data-group-id="3140262383-3">do</span><span class="w">
    </span><span class="n">uuid_primary_key</span><span class="w"> </span><span class="ss">:id</span><span class="w">

    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:email</span><span class="p">,</span><span class="w"> </span><span class="ss">:ci_string</span><span class="w"> </span><span class="k" data-group-id="3140262383-4">do</span><span class="w">
      </span><span class="n">allow_nil?</span><span class="w"> </span><span class="no">false</span><span class="w">
      </span><span class="n">public?</span><span class="w"> </span><span class="no">true</span><span class="w">
    </span><span class="k" data-group-id="3140262383-4">end</span><span class="w">

    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:hashed_password</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="p">,</span><span class="w"> </span><span class="ss">allow_nil?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">sensitive?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="k" data-group-id="3140262383-3">end</span><span class="w">

  </span><span class="n">authentication</span><span class="w"> </span><span class="k" data-group-id="3140262383-5">do</span><span class="w">
    </span><span class="n">strategies</span><span class="w"> </span><span class="k" data-group-id="3140262383-6">do</span><span class="w">
      </span><span class="n">password</span><span class="w"> </span><span class="ss">:password</span><span class="w"> </span><span class="k" data-group-id="3140262383-7">do</span><span class="w">
        </span><span class="n">identity_field</span><span class="w"> </span><span class="ss">:email</span><span class="w">
      </span><span class="k" data-group-id="3140262383-7">end</span><span class="w">
    </span><span class="k" data-group-id="3140262383-6">end</span><span class="w">

    </span><span class="n">tokens</span><span class="w"> </span><span class="k" data-group-id="3140262383-8">do</span><span class="w">
      </span><span class="n">enabled?</span><span class="w"> </span><span class="no">true</span><span class="w">
      </span><span class="n">token_resource</span><span class="w"> </span><span class="nc">Example.Accounts.Token</span><span class="w">
      </span><span class="n">signing_secret</span><span class="w"> </span><span class="nc">Example.Accounts.Secrets</span><span class="w">
    </span><span class="k" data-group-id="3140262383-8">end</span><span class="w">
  </span><span class="k" data-group-id="3140262383-5">end</span><span class="w">

  </span><span class="n">postgres</span><span class="w"> </span><span class="k" data-group-id="3140262383-9">do</span><span class="w">
    </span><span class="n">table</span><span class="w"> </span><span class="s">&quot;users&quot;</span><span class="w">
    </span><span class="n">repo</span><span class="w"> </span><span class="nc">Example.Repo</span><span class="w">
  </span><span class="k" data-group-id="3140262383-9">end</span><span class="w">

  </span><span class="n">identities</span><span class="w"> </span><span class="k" data-group-id="3140262383-10">do</span><span class="w">
    </span><span class="n">identity</span><span class="w"> </span><span class="ss">:unique_email</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3140262383-11">[</span><span class="ss">:email</span><span class="p" data-group-id="3140262383-11">]</span><span class="w">
  </span><span class="k" data-group-id="3140262383-10">end</span><span class="w">

  </span><span class="c1"># If using policies, add the following bypass:</span><span class="w">
  </span><span class="c1"># policies do</span><span class="w">
  </span><span class="c1">#   bypass AshAuthentication.Checks.AshAuthenticationInteraction do</span><span class="w">
  </span><span class="c1">#     authorize_if always()</span><span class="w">
  </span><span class="c1">#   end</span><span class="w">
  </span><span class="c1"># end</span><span class="w">
</span><span class="k" data-group-id="3140262383-1">end</span></code></pre><p><strong>lib/example/accounts/secrets.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Example.Accounts.Secrets</span><span class="w"> </span><span class="k" data-group-id="3909472185-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">AshAuthentication.Secret</span><span class="w">


  </span><span class="kd">def</span><span class="w"> </span><span class="nf">secret_for</span><span class="p" data-group-id="3909472185-2">(</span><span class="p" data-group-id="3909472185-3">[</span><span class="ss">:authentication</span><span class="p">,</span><span class="w"> </span><span class="ss">:tokens</span><span class="p">,</span><span class="w"> </span><span class="ss">:signing_secret</span><span class="p" data-group-id="3909472185-3">]</span><span class="p">,</span><span class="w"> </span><span class="nc">Example.Accounts.User</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="3909472185-2">)</span><span class="w"> </span><span class="k" data-group-id="3909472185-4">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Application</span><span class="o">.</span><span class="n">fetch_env</span><span class="p" data-group-id="3909472185-5">(</span><span class="ss">:example</span><span class="p">,</span><span class="w"> </span><span class="nc">ExampleWeb.Endpoint</span><span class="p" data-group-id="3909472185-5">)</span><span class="w"> </span><span class="k" data-group-id="3909472185-6">do</span><span class="w">
      </span><span class="p" data-group-id="3909472185-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">endpoint_config</span><span class="p" data-group-id="3909472185-7">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">fetch</span><span class="p" data-group-id="3909472185-8">(</span><span class="n">endpoint_config</span><span class="p">,</span><span class="w"> </span><span class="ss">:secret_key_base</span><span class="p" data-group-id="3909472185-8">)</span><span class="w">
      </span><span class="ss">:error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="ss">:error</span><span class="w">
    </span><span class="k" data-group-id="3909472185-6">end</span><span class="w">
  </span><span class="k" data-group-id="3909472185-4">end</span><span class="w">
</span><span class="k" data-group-id="3909472185-1">end</span></code></pre><p><strong>lib/example/accounts/token.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Example.Accounts.Token</span><span class="w"> </span><span class="k" data-group-id="7921895864-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">Example.Accounts</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">AshPostgres.DataLayer</span><span class="p">,</span><span class="w">
    </span><span class="c1"># If using policies, enable the policy authorizer:</span><span class="w">
    </span><span class="c1"># authorizers: [Ash.Policy.Authorizer],</span><span class="w">
    </span><span class="ss">extensions</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7921895864-2">[</span><span class="nc">AshAuthentication.TokenResource</span><span class="p" data-group-id="7921895864-2">]</span><span class="w">

  </span><span class="n">postgres</span><span class="w"> </span><span class="k" data-group-id="7921895864-3">do</span><span class="w">
    </span><span class="n">table</span><span class="w"> </span><span class="s">&quot;tokens&quot;</span><span class="w">
    </span><span class="n">repo</span><span class="w"> </span><span class="nc">Example.Repo</span><span class="w">
  </span><span class="k" data-group-id="7921895864-3">end</span><span class="w">

  </span><span class="c1"># If using policies, add the following bypass:</span><span class="w">
  </span><span class="c1"># policies do</span><span class="w">
  </span><span class="c1">#   bypass AshAuthentication.Checks.AshAuthenticationInteraction do</span><span class="w">
  </span><span class="c1">#     authorize_if always()</span><span class="w">
  </span><span class="c1">#   end</span><span class="w">
  </span><span class="c1"># end</span><span class="w">
</span><span class="k" data-group-id="7921895864-1">end</span></code></pre><p><strong>lib/example/accounts/accounts.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Example.Accounts</span><span class="w"> </span><span class="k" data-group-id="6281736563-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Domain</span><span class="w">

  </span><span class="n">resources</span><span class="w"> </span><span class="k" data-group-id="6281736563-2">do</span><span class="w">
    </span><span class="n">resource</span><span class="w"> </span><span class="nc">Example.Accounts.User</span><span class="w">
    </span><span class="n">resource</span><span class="w"> </span><span class="nc">Example.Accounts.Token</span><span class="w">
  </span><span class="k" data-group-id="6281736563-2">end</span><span class="w">
</span><span class="k" data-group-id="6281736563-1">end</span></code></pre><h3 id="add-to-config" class="section-heading">
  <a href="#add-to-config" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Add to config</span>
</h3>
<p>Although mentioned in a step at the top, a common mistake here is not to add the new domain into your <code class="inline">ash_domains</code> config in <code class="inline">config/config.exs</code>. It should look like this:</p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:example</span><span class="p">,</span><span class="w">
  </span><span class="ss">ash_domains</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0992174151-1">[</span><span class="n">...</span><span class="p">,</span><span class="w"> </span><span class="nc">Example.Accounts</span><span class="p" data-group-id="0992174151-1">]</span></code></pre><h3 id="create-and-migration" class="section-heading">
  <a href="#create-and-migration" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Create and Migration</span>
</h3>
<p>Now is a good time to create the database and run the migrations. You have to use specific <code class="inline">ash_postgres</code> mix tasks for that:</p><pre><code class="makeup bash" translate="no"><span class="gp unselectable">$ </span><span class="">mix ash_postgres.create
</span><span class="gp unselectable">$ </span><span class="">mix ash_postgres.generate_migrations --name add_user_and_token
</span><span class="gp unselectable">$ </span><span class="">mix ash_postgres.migrate
</span></code></pre><blockquote><p>In case you want to drop the database and start over again during development you can use <code class="inline">mix ash_postgres.drop</code> followed by <code class="inline">mix ash_postgres.create</code> and <code class="inline">mix ash_postgres.migrate</code>.</p></blockquote><h2 id="router-setup" class="section-heading">
  <a href="#router-setup" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Router Setup</span>
</h2>
<p><code class="inline">ash_authentication_phoenix</code> includes several helper macros which can generate
Phoenix routes for you. For that you need to add 6 lines in the router module or just replace the whole file with the following code:</p><p><strong>lib/example_web/router.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ExampleWeb.Router</span><span class="w"> </span><span class="k" data-group-id="7226050537-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExampleWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:router</span><span class="w">
  </span><span class="c1"># Add this line</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">AshAuthentication.Phoenix.Router</span><span class="w">

  </span><span class="n">pipeline</span><span class="w"> </span><span class="ss">:browser</span><span class="w"> </span><span class="k" data-group-id="7226050537-2">do</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:accepts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7226050537-3">[</span><span class="s">&quot;html&quot;</span><span class="p" data-group-id="7226050537-3">]</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:fetch_session</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:fetch_live_flash</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:put_root_layout</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7226050537-4">{</span><span class="nc">ExampleWeb.Layouts</span><span class="p">,</span><span class="w"> </span><span class="ss">:root</span><span class="p" data-group-id="7226050537-4">}</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:protect_from_forgery</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:put_secure_browser_headers</span><span class="w">
    </span><span class="c1"># Add the next line</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:load_from_session</span><span class="w">
  </span><span class="k" data-group-id="7226050537-2">end</span><span class="w">

  </span><span class="n">pipeline</span><span class="w"> </span><span class="ss">:api</span><span class="w"> </span><span class="k" data-group-id="7226050537-5">do</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:accepts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7226050537-6">[</span><span class="s">&quot;json&quot;</span><span class="p" data-group-id="7226050537-6">]</span><span class="w">
    </span><span class="c1"># Add the next line</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:load_from_bearer</span><span class="w">
  </span><span class="k" data-group-id="7226050537-5">end</span><span class="w">

  </span><span class="n">scope</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">ExampleWeb</span><span class="w"> </span><span class="k" data-group-id="7226050537-7">do</span><span class="w">
    </span><span class="n">pipe_through</span><span class="w"> </span><span class="ss">:browser</span><span class="w">

    </span><span class="n">get</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">PageController</span><span class="p">,</span><span class="w"> </span><span class="ss">:home</span><span class="w">

    </span><span class="c1"># add these lines --&gt;</span><span class="w">

    </span><span class="c1"># Standard controller-backed routes</span><span class="w">
    </span><span class="n">auth_routes</span><span class="w"> </span><span class="nc">AuthController</span><span class="p">,</span><span class="w"> </span><span class="nc">Example.Accounts.User</span><span class="p">,</span><span class="w"> </span><span class="ss">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/auth&quot;</span><span class="w">
    </span><span class="n">sign_out_route</span><span class="w"> </span><span class="nc">AuthController</span><span class="w">

    </span><span class="c1"># Prebuilt LiveViews for signing in, registration, resetting, etc.</span><span class="w">
    </span><span class="c1"># Leave out `register_path` and `reset_path` if you don&#39;t want to support</span><span class="w">
    </span><span class="c1"># user registration and/or password resets respectively.</span><span class="w">
    </span><span class="n">sign_in_route</span><span class="p" data-group-id="7226050537-8">(</span><span class="ss">register_path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/register&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">reset_path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/reset&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">auth_routes_prefix</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/auth&quot;</span><span class="p" data-group-id="7226050537-8">)</span><span class="w">
    </span><span class="n">reset_route</span><span class="w"> </span><span class="p" data-group-id="7226050537-9">[</span><span class="p" data-group-id="7226050537-9">]</span><span class="w">

    </span><span class="c1"># &lt;-- add these lines</span><span class="w">
  </span><span class="k" data-group-id="7226050537-7">end</span><span class="w">

  </span><span class="c1"># Other scopes may use custom stacks.</span><span class="w">
  </span><span class="c1"># scope &quot;/api&quot;, ExampleWeb do</span><span class="w">
  </span><span class="c1">#   pipe_through :api</span><span class="w">
  </span><span class="c1"># end</span><span class="w">

  </span><span class="c1"># Enable LiveDashboard and Swoosh mailbox preview in development</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="nc">Application</span><span class="o">.</span><span class="n">compile_env</span><span class="p" data-group-id="7226050537-10">(</span><span class="ss">:example</span><span class="p">,</span><span class="w"> </span><span class="ss">:dev_routes</span><span class="p" data-group-id="7226050537-10">)</span><span class="w"> </span><span class="k" data-group-id="7226050537-11">do</span><span class="w">
    </span><span class="c1"># If you want to use the LiveDashboard in production, you should put</span><span class="w">
    </span><span class="c1"># it behind authentication and allow only admins to access it.</span><span class="w">
    </span><span class="c1"># If your application does not have an admins-only section yet,</span><span class="w">
    </span><span class="c1"># you can use Plug.BasicAuth to set up some basic authentication</span><span class="w">
    </span><span class="c1"># as long as you are also using SSL (which you should anyway).</span><span class="w">
    </span><span class="kn">import</span><span class="w"> </span><span class="nc">Phoenix.LiveDashboard.Router</span><span class="w">

    </span><span class="n">scope</span><span class="w"> </span><span class="s">&quot;/dev&quot;</span><span class="w"> </span><span class="k" data-group-id="7226050537-12">do</span><span class="w">
      </span><span class="n">pipe_through</span><span class="w"> </span><span class="ss">:browser</span><span class="w">

      </span><span class="n">live_dashboard</span><span class="w"> </span><span class="s">&quot;/dashboard&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">metrics</span><span class="p">:</span><span class="w"> </span><span class="nc">ExampleWeb.Telemetry</span><span class="w">
      </span><span class="n">forward</span><span class="w"> </span><span class="s">&quot;/mailbox&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">Plug.Swoosh.MailboxPreview</span><span class="w">
    </span><span class="k" data-group-id="7226050537-12">end</span><span class="w">
  </span><span class="k" data-group-id="7226050537-11">end</span><span class="w">
</span><span class="k" data-group-id="7226050537-1">end</span></code></pre><h3 id="generated-routes" class="section-heading">
  <a href="#generated-routes" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Generated routes</span>
</h3>
<p>Given the above configuration you should see the following in your routes:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># mix phx.routes</span><span class="w">

</span><span class="nc">Generated</span><span class="w"> </span><span class="n">example</span><span class="w"> </span><span class="n">app</span><span class="w">
          </span><span class="n">auth_path</span><span class="w">  </span><span class="nc">GET</span><span class="w">  </span><span class="o">/</span><span class="n">sign</span><span class="o">-</span><span class="ow">in</span><span class="w">                               </span><span class="nc">AshAuthentication.Phoenix.SignInLive</span><span class="w"> </span><span class="ss">:sign_in</span><span class="w">
          </span><span class="n">auth_path</span><span class="w">  </span><span class="nc">GET</span><span class="w">  </span><span class="o">/</span><span class="n">sign</span><span class="o">-</span><span class="n">out</span><span class="w">                              </span><span class="nc">ExampleWeb.AuthController</span><span class="w"> </span><span class="ss">:sign_out</span><span class="w">
          </span><span class="n">auth_path</span><span class="w">  </span><span class="o">*</span><span class="w">    </span><span class="o">/</span><span class="n">auth</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">password</span><span class="o">/</span><span class="n">register</span><span class="w">           </span><span class="nc">ExampleWeb.AuthController</span><span class="w"> </span><span class="p" data-group-id="8665983813-1">{</span><span class="ss">:user</span><span class="p">,</span><span class="w"> </span><span class="ss">:password</span><span class="p">,</span><span class="w"> </span><span class="ss">:register</span><span class="p" data-group-id="8665983813-1">}</span><span class="w">
          </span><span class="n">auth_path</span><span class="w">  </span><span class="o">*</span><span class="w">    </span><span class="o">/</span><span class="n">auth</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">password</span><span class="o">/</span><span class="n">sign_in</span><span class="w">            </span><span class="nc">ExampleWeb.AuthController</span><span class="w"> </span><span class="p" data-group-id="8665983813-2">{</span><span class="ss">:user</span><span class="p">,</span><span class="w"> </span><span class="ss">:password</span><span class="p">,</span><span class="w"> </span><span class="ss">:sign_in</span><span class="p" data-group-id="8665983813-2">}</span><span class="w">
          </span><span class="n">page_path</span><span class="w">  </span><span class="nc">GET</span><span class="w">  </span><span class="o">/</span><span class="w">                                      </span><span class="nc">ExampleWeb.PageController</span><span class="w"> </span><span class="ss">:home</span><span class="w">
</span><span class="n">...</span></code></pre><h3 id="customizing-the-generated-routes" class="section-heading">
  <a href="#customizing-the-generated-routes" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Customizing the generated routes</span>
</h3>
<p>If you're integrating AshAuthentication into an existing app, you probably already have existing HTML layouts you want to use, to wrap the provided sign in/forgot password/etc. forms.</p><p>Liveviews provided by AshAuthentication.Phoenix will use the same root layout configured in your router's <code class="inline">:browser</code> pipeline, but it includes its own layout file primarily for rendering flash messages.</p><p>If you would like to use your own layout file instead, you can specify this as an option to the route helpers, eg.</p><pre><code class="makeup elixir" translate="no"><span class="n">reset_route</span><span class="p" data-group-id="6029060171-1">(</span><span class="ss">layout</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6029060171-2">{</span><span class="nc">MyAppWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live</span><span class="p" data-group-id="6029060171-2">}</span><span class="p" data-group-id="6029060171-1">)</span></code></pre><h2 id="authcontroller" class="section-heading">
  <a href="#authcontroller" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">AuthController</span>
</h2>
<p>While running <a href="https://hexdocs.pm/phoenix/1.7.14/Mix.Tasks.Phx.Routes.html"><code class="inline">mix phx.routes</code></a> you probably saw the warning message that the <code class="inline">ExampleWeb.AuthController.init/1 is undefined</code>. Let's fix that by creating a new controller:</p><p><strong>lib/example_web/controllers/auth_controller.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ExampleWeb.AuthController</span><span class="w"> </span><span class="k" data-group-id="6112718060-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExampleWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:controller</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">AshAuthentication.Phoenix.Controller</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">success</span><span class="p" data-group-id="6112718060-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_activity</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="c">_token</span><span class="p" data-group-id="6112718060-2">)</span><span class="w"> </span><span class="k" data-group-id="6112718060-3">do</span><span class="w">
    </span><span class="n">return_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_session</span><span class="p" data-group-id="6112718060-4">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:return_to</span><span class="p" data-group-id="6112718060-4">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sx">~p&quot;/&quot;</span><span class="w">

    </span><span class="n">conn</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">delete_session</span><span class="p" data-group-id="6112718060-5">(</span><span class="ss">:return_to</span><span class="p" data-group-id="6112718060-5">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">store_in_session</span><span class="p" data-group-id="6112718060-6">(</span><span class="n">user</span><span class="p" data-group-id="6112718060-6">)</span><span class="w">
    </span><span class="c1"># If your resource has a different name, update the assign name here (i.e :current_admin)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6112718060-7">(</span><span class="ss">:current_user</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="6112718060-7">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="6112718060-8">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="n">return_to</span><span class="p" data-group-id="6112718060-8">)</span><span class="w">
  </span><span class="k" data-group-id="6112718060-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">failure</span><span class="p" data-group-id="6112718060-9">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_activity</span><span class="p">,</span><span class="w"> </span><span class="c">_reason</span><span class="p" data-group-id="6112718060-9">)</span><span class="w"> </span><span class="k" data-group-id="6112718060-10">do</span><span class="w">
    </span><span class="n">conn</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_flash</span><span class="p" data-group-id="6112718060-11">(</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Incorrect email or password&quot;</span><span class="p" data-group-id="6112718060-11">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="6112718060-12">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="sx">~p&quot;/sign-in&quot;</span><span class="p" data-group-id="6112718060-12">)</span><span class="w">
  </span><span class="k" data-group-id="6112718060-10">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">sign_out</span><span class="p" data-group-id="6112718060-13">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_params</span><span class="p" data-group-id="6112718060-13">)</span><span class="w"> </span><span class="k" data-group-id="6112718060-14">do</span><span class="w">
    </span><span class="n">return_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_session</span><span class="p" data-group-id="6112718060-15">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:return_to</span><span class="p" data-group-id="6112718060-15">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sx">~p&quot;/&quot;</span><span class="w">

    </span><span class="n">conn</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">clear_session</span><span class="p" data-group-id="6112718060-16">(</span><span class="p" data-group-id="6112718060-16">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="p" data-group-id="6112718060-17">(</span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="n">return_to</span><span class="p" data-group-id="6112718060-17">)</span><span class="w">
  </span><span class="k" data-group-id="6112718060-14">end</span><span class="w">
</span><span class="k" data-group-id="6112718060-1">end</span></code></pre><p><strong>lib/example_web/controllers/auth_html.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ExampleWeb.AuthHTML</span><span class="w"> </span><span class="k" data-group-id="8754819738-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExampleWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:html</span><span class="w">

  </span><span class="n">embed_templates</span><span class="w"> </span><span class="s">&quot;auth_html/*&quot;</span><span class="w">
</span><span class="k" data-group-id="8754819738-1">end</span></code></pre><p><strong>lib/example_web/controllers/auth_html/failure.html.heex</strong></p><pre><code class="makeup html" translate="no"><span class="p" data-group-id="6732537292-1">&lt;</span><span class="k">h1</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;text-2xl&quot;</span><span class="p" data-group-id="6732537292-1">&gt;</span><span class="s">Authentication Error</span><span class="p" data-group-id="6732537292-2">&lt;/</span><span class="k">h1</span><span class="p" data-group-id="6732537292-2">&gt;</span></code></pre><h2 id="example-home-html-heex" class="section-heading">
  <a href="#example-home-html-heex" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Example home.html.heex</span>
</h2>
<p>To see how the authentication works we replace the default Phoenix <code class="inline">home.html.eex</code> with a minimal example which has a top navbar. On the right side it shows the <code class="inline">@current_user</code> and a sign out button. If you are not signed in you will see a sign in button.</p><p><strong>lib/example_web/controllers/page_html/home.html.heex</strong></p><pre><code class="makeup html" translate="no"><span class="p" data-group-id="4909015220-1">&lt;</span><span class="k">nav</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;bg-gray-800&quot;</span><span class="p" data-group-id="4909015220-1">&gt;</span><span class="s">
  </span><span class="p" data-group-id="4909015220-2">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;px-2</span><span class="w"> </span><span class="s">mx-auto</span><span class="w"> </span><span class="s">max-w-7xl</span><span class="w"> </span><span class="s">sm:px-6</span><span class="w"> </span><span class="s">lg:px-8&quot;</span><span class="p" data-group-id="4909015220-2">&gt;</span><span class="s">
    </span><span class="p" data-group-id="4909015220-3">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;relative</span><span class="w"> </span><span class="s">flex</span><span class="w"> </span><span class="s">items-center</span><span class="w"> </span><span class="s">justify-between</span><span class="w"> </span><span class="s">h-16&quot;</span><span class="p" data-group-id="4909015220-3">&gt;</span><span class="s">
      </span><span class="p" data-group-id="4909015220-4">&lt;</span><span class="k">div</span><span class="w">
        </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;flex</span><span class="w"> </span><span class="s">items-center</span><span class="w"> </span><span class="s">justify-center</span><span class="w"> </span><span class="s">flex-1</span><span class="w"> </span><span class="s">sm:items-stretch</span><span class="w"> </span><span class="s">sm:justify-start&quot;</span><span class="w">
      </span><span class="p" data-group-id="4909015220-4">&gt;</span><span class="s">
        </span><span class="p" data-group-id="4909015220-5">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;block</span><span class="w"> </span><span class="s">ml-6&quot;</span><span class="p" data-group-id="4909015220-5">&gt;</span><span class="s">
          </span><span class="p" data-group-id="4909015220-6">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;flex</span><span class="w"> </span><span class="s">space-x-4&quot;</span><span class="p" data-group-id="4909015220-6">&gt;</span><span class="s">
            </span><span class="p" data-group-id="4909015220-7">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;px-3</span><span class="w"> </span><span class="s">py-2</span><span class="w"> </span><span class="s">text-xl</span><span class="w"> </span><span class="s">font-medium</span><span class="w"> </span><span class="s">text-white</span><span class="w"> </span><span class="s">&quot;</span><span class="p" data-group-id="4909015220-7">&gt;</span><span class="s">
              Ash Demo
            </span><span class="p" data-group-id="4909015220-8">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-8">&gt;</span><span class="s">
          </span><span class="p" data-group-id="4909015220-9">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-9">&gt;</span><span class="s">
        </span><span class="p" data-group-id="4909015220-10">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-10">&gt;</span><span class="s">
      </span><span class="p" data-group-id="4909015220-11">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-11">&gt;</span><span class="s">
      </span><span class="p" data-group-id="4909015220-12">&lt;</span><span class="k">div</span><span class="w">
        </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;absolute</span><span class="w"> </span><span class="s">inset-y-0</span><span class="w"> </span><span class="s">right-0</span><span class="w"> </span><span class="s">flex</span><span class="w"> </span><span class="s">items-center</span><span class="w"> </span><span class="s">pr-2</span><span class="w"> </span><span class="s">sm:static</span><span class="w"> </span><span class="s">sm:inset-auto</span><span class="w"> </span><span class="s">sm:ml-6</span><span class="w"> </span><span class="s">sm:pr-0&quot;</span><span class="w">
      </span><span class="p" data-group-id="4909015220-12">&gt;</span><span class="s">
        </span><span class="p" data-group-id="4909015220-13">&lt;</span><span class="s">%</span><span class="o">=</span><span class="w"> </span><span class="s">if</span><span class="w"> </span><span class="s">@current_user</span><span class="w"> </span><span class="s">do</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="4909015220-13">&gt;</span><span class="s">
        </span><span class="p" data-group-id="4909015220-14">&lt;</span><span class="k">span</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;px-3</span><span class="w"> </span><span class="s">py-2</span><span class="w"> </span><span class="s">text-sm</span><span class="w"> </span><span class="s">font-medium</span><span class="w"> </span><span class="s">text-white</span><span class="w"> </span><span class="s">rounded-md&quot;</span><span class="p" data-group-id="4909015220-14">&gt;</span><span class="s">
          </span><span class="p" data-group-id="4909015220-15">&lt;</span><span class="s">%</span><span class="o">=</span><span class="w"> </span><span class="s">@current_user.email</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="4909015220-15">&gt;</span><span class="s">
        </span><span class="p" data-group-id="4909015220-16">&lt;/</span><span class="k">span</span><span class="p" data-group-id="4909015220-16">&gt;</span><span class="s">
        </span><span class="p" data-group-id="4909015220-17">&lt;</span><span class="k">a</span><span class="w">
          </span><span class="na">href</span><span class="o">=</span><span class="s">&quot;/sign-out&quot;</span><span class="w">
          </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;rounded-lg</span><span class="w"> </span><span class="s">bg-zinc-100</span><span class="w"> </span><span class="s">px-2</span><span class="w"> </span><span class="s">py-1</span><span class="w"> </span><span class="s">text-[0.8125rem]</span><span class="w"> </span><span class="s">font-semibold</span><span class="w"> </span><span class="s">leading-6</span><span class="w"> </span><span class="s">text-zinc-900</span><span class="w"> </span><span class="s">hover:bg-zinc-200/80</span><span class="w"> </span><span class="s">active:text-zinc-900/70&quot;</span><span class="w">
        </span><span class="p" data-group-id="4909015220-17">&gt;</span><span class="s">
          Sign out
        </span><span class="p" data-group-id="4909015220-18">&lt;/</span><span class="k">a</span><span class="p" data-group-id="4909015220-18">&gt;</span><span class="s">
        </span><span class="p" data-group-id="4909015220-19">&lt;</span><span class="s">%</span><span class="w"> </span><span class="s">else</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="4909015220-19">&gt;</span><span class="s">
        </span><span class="p" data-group-id="4909015220-20">&lt;</span><span class="k">a</span><span class="w">
          </span><span class="na">href</span><span class="o">=</span><span class="s">&quot;/sign-in&quot;</span><span class="w">
          </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;rounded-lg</span><span class="w"> </span><span class="s">bg-zinc-100</span><span class="w"> </span><span class="s">px-2</span><span class="w"> </span><span class="s">py-1</span><span class="w"> </span><span class="s">text-[0.8125rem]</span><span class="w"> </span><span class="s">font-semibold</span><span class="w"> </span><span class="s">leading-6</span><span class="w"> </span><span class="s">text-zinc-900</span><span class="w"> </span><span class="s">hover:bg-zinc-200/80</span><span class="w"> </span><span class="s">active:text-zinc-900/70&quot;</span><span class="w">
        </span><span class="p" data-group-id="4909015220-20">&gt;</span><span class="s">
          Sign In
        </span><span class="p" data-group-id="4909015220-21">&lt;/</span><span class="k">a</span><span class="p" data-group-id="4909015220-21">&gt;</span><span class="s">
        </span><span class="p" data-group-id="4909015220-22">&lt;</span><span class="s">%</span><span class="w"> </span><span class="s">end</span><span class="w"> </span><span class="s">%</span><span class="p" data-group-id="4909015220-22">&gt;</span><span class="s">
      </span><span class="p" data-group-id="4909015220-23">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-23">&gt;</span><span class="s">
    </span><span class="p" data-group-id="4909015220-24">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-24">&gt;</span><span class="s">
  </span><span class="p" data-group-id="4909015220-25">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-25">&gt;</span><span class="s">
</span><span class="p" data-group-id="4909015220-26">&lt;/</span><span class="k">nav</span><span class="p" data-group-id="4909015220-26">&gt;</span><span class="s">

</span><span class="p" data-group-id="4909015220-27">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;py-10&quot;</span><span class="p" data-group-id="4909015220-27">&gt;</span><span class="s">
  </span><span class="p" data-group-id="4909015220-28">&lt;</span><span class="k">header</span><span class="p" data-group-id="4909015220-28">&gt;</span><span class="s">
    </span><span class="p" data-group-id="4909015220-29">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;px-4</span><span class="w"> </span><span class="s">mx-auto</span><span class="w"> </span><span class="s">max-w-7xl</span><span class="w"> </span><span class="s">sm:px-6</span><span class="w"> </span><span class="s">lg:px-8&quot;</span><span class="p" data-group-id="4909015220-29">&gt;</span><span class="s">
      </span><span class="p" data-group-id="4909015220-30">&lt;</span><span class="k">h1</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;text-3xl</span><span class="w"> </span><span class="s">font-bold</span><span class="w"> </span><span class="s">leading-tight</span><span class="w"> </span><span class="s">tracking-tight</span><span class="w"> </span><span class="s">text-gray-900&quot;</span><span class="p" data-group-id="4909015220-30">&gt;</span><span class="s">
        Demo
      </span><span class="p" data-group-id="4909015220-31">&lt;/</span><span class="k">h1</span><span class="p" data-group-id="4909015220-31">&gt;</span><span class="s">
    </span><span class="p" data-group-id="4909015220-32">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-32">&gt;</span><span class="s">
  </span><span class="p" data-group-id="4909015220-33">&lt;/</span><span class="k">header</span><span class="p" data-group-id="4909015220-33">&gt;</span><span class="s">
  </span><span class="p" data-group-id="4909015220-34">&lt;</span><span class="k">main</span><span class="p" data-group-id="4909015220-34">&gt;</span><span class="s">
    </span><span class="p" data-group-id="4909015220-35">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;mx-auto</span><span class="w"> </span><span class="s">max-w-7xl</span><span class="w"> </span><span class="s">sm:px-6</span><span class="w"> </span><span class="s">lg:px-8&quot;</span><span class="p" data-group-id="4909015220-35">&gt;</span><span class="s">
      </span><span class="p" data-group-id="4909015220-36">&lt;</span><span class="k">div</span><span class="w"> </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;px-4</span><span class="w"> </span><span class="s">py-8</span><span class="w"> </span><span class="s">sm:px-0&quot;</span><span class="p" data-group-id="4909015220-36">&gt;</span><span class="s">
        </span><span class="p" data-group-id="4909015220-37">&lt;</span><span class="k">div</span><span class="w">
          </span><span class="na">class</span><span class="o">=</span><span class="s">&quot;border-4</span><span class="w"> </span><span class="s">border-gray-200</span><span class="w"> </span><span class="s">border-dashed</span><span class="w"> </span><span class="s">rounded-lg</span><span class="w"> </span><span class="s">h-96&quot;</span><span class="w">
        </span><span class="p" data-group-id="4909015220-37">&gt;</span><span class="p" data-group-id="4909015220-38">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-38">&gt;</span><span class="s">
      </span><span class="p" data-group-id="4909015220-39">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-39">&gt;</span><span class="s">
    </span><span class="p" data-group-id="4909015220-40">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-40">&gt;</span><span class="s">
  </span><span class="p" data-group-id="4909015220-41">&lt;/</span><span class="k">main</span><span class="p" data-group-id="4909015220-41">&gt;</span><span class="s">
</span><span class="p" data-group-id="4909015220-42">&lt;/</span><span class="k">div</span><span class="p" data-group-id="4909015220-42">&gt;</span></code></pre><h3 id="if-you-are-using-liveview" class="section-heading">
  <a href="#if-you-are-using-liveview" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">If you are using LiveView</span>
</h3>
<p>If you are using LiveView, jump over to the <a href="liveview.html">Use AshAuthentication with LiveView</a>
section and set up your LiveView routes for <a href="https://hexdocs.pm/ash_authentication/4.0.4/AshAuthentication.html"><code class="inline">AshAuthentication</code></a>. Once that is done, you can proceed with the following steps.</p><h3 id="start-phoenix" class="section-heading">
  <a href="#start-phoenix" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Start Phoenix</span>
</h3>
<p>You can now start Phoenix and visit
<a href="http://localhost:4000"><code class="inline">localhost:4000</code></a> from your browser.</p><pre><code class="makeup bash" translate="no"><span class="gp unselectable">$ </span><span class="">mix phx.server
</span></code></pre><h3 id="sign-in" class="section-heading">
  <a href="#sign-in" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Sign In</span>
</h3>
<p>Visit <a href="http://localhost:4000/sign-in"><code class="inline">localhost:4000/sign-in</code></a> from your browser.</p><p>The sign in page shows a link to register a new account.</p><h3 id="sign-out" class="section-heading">
  <a href="#sign-out" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Sign Out</span>
</h3>
<p>Visit <a href="http://localhost:4000/sign-out"><code class="inline">localhost:4000/sign-out</code></a> from your browser.</p><h3 id="debugging-the-authentication-flow" class="section-heading">
  <a href="#debugging-the-authentication-flow" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Debugging the Authentication flow</span>
</h3>
<p>The default authentication view shows a generic error message to users if their sign-in fails, like &quot;Email or password was incorrect&quot;. This is for security purposes - you don't want potentially malicious people to know if an email address definitively exists in your system.</p><p>However, if you're having issues setting up AshAuthentication, or trying to debug issues with your implementation, that error message isn't super useful to figure out what's going wrong.</p><p>To that end, AshAuthentication comes with debug functionality that can be enabled in dev:</p><p><strong>config/dev.exs</strong></p><pre><code class="makeup elixir" translate="no"><span class="n">config</span><span class="w"> </span><span class="ss">:ash_authentication</span><span class="p">,</span><span class="w"> </span><span class="ss">debug_authentication_failures?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span></code></pre><blockquote><h4 class="warning">Don't enable debugging outside <code class="inline">dev</code> environments!</h4><p>This could leak users' personally-identifiable information (PII) into your logs on failed sign-in attempts - a security issue!</p></blockquote><p>Once the config is added, you can restart your dev server and test what happens when you visit the sign-in page and submit invalid credentials. You should see log messages like -</p><pre><code class="text">[timestamp] [warning] Authentication failed: Query returned no users

Details: %AshAuthentication.Errors.AuthenticationFailed{
  field: nil,
  strategy: %AshAuthentication.Strategy.Password{
    confirmation_required?: true,
    ...</code></pre><h2 id="reset-password" class="section-heading">
  <a href="#reset-password" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Reset Password</span>
</h2>
<p>In this section we add a reset password functionality. Which is triggered by adding <code class="inline">resettable</code> in the <code class="inline">User</code> resource. Please replace the <code class="inline">strategies</code> block in <code class="inline">lib/example/accounts/user.ex</code> with the following code:</p><p><strong>lib/example/accounts/user.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># [...]</span><span class="w">
</span><span class="n">strategies</span><span class="w"> </span><span class="k" data-group-id="5991708461-1">do</span><span class="w">
  </span><span class="n">password</span><span class="w"> </span><span class="ss">:password</span><span class="w"> </span><span class="k" data-group-id="5991708461-2">do</span><span class="w">
    </span><span class="n">identity_field</span><span class="w"> </span><span class="ss">:email</span><span class="w">

    </span><span class="n">resettable</span><span class="w"> </span><span class="k" data-group-id="5991708461-3">do</span><span class="w">
      </span><span class="n">sender</span><span class="w"> </span><span class="nc">Example.Accounts.User.Senders.SendPasswordResetEmail</span><span class="w">
    </span><span class="k" data-group-id="5991708461-3">end</span><span class="w">
  </span><span class="k" data-group-id="5991708461-2">end</span><span class="w">
</span><span class="k" data-group-id="5991708461-1">end</span><span class="w">
</span><span class="c1"># [...]</span></code></pre><p>To make this work we need to create a new module <code class="inline">Example.Accounts.User.Senders.SendPasswordResetEmail</code>:</p><p><strong>lib/example/accounts/user/senders/send_password_reset_email.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Example.Accounts.User.Senders.SendPasswordResetEmail</span><span class="w"> </span><span class="k" data-group-id="8128155679-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Sends a password reset email
  &quot;&quot;&quot;</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">AshAuthentication.Sender</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">ExampleWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:verified_routes</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="nc">AshAuthentication.Sender</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">send</span><span class="p" data-group-id="8128155679-2">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="8128155679-2">)</span><span class="w"> </span><span class="k" data-group-id="8128155679-3">do</span><span class="w">
    </span><span class="nc">Example.Accounts.Emails</span><span class="o">.</span><span class="n">deliver_reset_password_instructions</span><span class="p" data-group-id="8128155679-4">(</span><span class="w">
      </span><span class="n">user</span><span class="p">,</span><span class="w">
      </span><span class="n">url</span><span class="p" data-group-id="8128155679-5">(</span><span class="sx">~p&quot;/password-reset/</span><span class="si" data-group-id="8128155679-6">#{</span><span class="n">token</span><span class="si" data-group-id="8128155679-6">}</span><span class="sx">&quot;</span><span class="p" data-group-id="8128155679-5">)</span><span class="w">
    </span><span class="p" data-group-id="8128155679-4">)</span><span class="w">
  </span><span class="k" data-group-id="8128155679-3">end</span><span class="w">
</span><span class="k" data-group-id="8128155679-1">end</span></code></pre><p>We also need to create a new email template:</p><p><strong>lib/example/accounts/emails.ex</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Example.Accounts.Emails</span><span class="w"> </span><span class="k" data-group-id="2714459088-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Delivers emails.
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Swoosh.Email</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">deliver_reset_password_instructions</span><span class="p" data-group-id="2714459088-2">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="p" data-group-id="2714459088-2">)</span><span class="w"> </span><span class="k" data-group-id="2714459088-3">do</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">url</span><span class="w"> </span><span class="k" data-group-id="2714459088-4">do</span><span class="w">
      </span><span class="k">raise</span><span class="w"> </span><span class="s">&quot;Cannot deliver reset instructions without a url&quot;</span><span class="w">
    </span><span class="k" data-group-id="2714459088-4">end</span><span class="w">

    </span><span class="n">deliver</span><span class="p" data-group-id="2714459088-5">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Reset Your Password&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
    &lt;html&gt;
      &lt;p&gt;
        Hi </span><span class="si" data-group-id="2714459088-6">#{</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="si" data-group-id="2714459088-6">}</span><span class="s">,
      &lt;/p&gt;

      &lt;p&gt;
        &lt;a href=&quot;</span><span class="si" data-group-id="2714459088-7">#{</span><span class="n">url</span><span class="si" data-group-id="2714459088-7">}</span><span class="s">&quot;&gt;Click here&lt;/a&gt; to reset your password.
      &lt;/p&gt;

      &lt;p&gt;
        If you didn&#39;t request this change, please ignore this.
      &lt;/p&gt;
    &lt;html&gt;
    &quot;&quot;&quot;</span><span class="p" data-group-id="2714459088-5">)</span><span class="w">
  </span><span class="k" data-group-id="2714459088-3">end</span><span class="w">

  </span><span class="c1"># For simplicity, this module simply logs messages to the terminal.</span><span class="w">
  </span><span class="c1"># You should replace it by a proper email or notification tool, such as:</span><span class="w">
  </span><span class="c1">#</span><span class="w">
  </span><span class="c1">#   * Swoosh - https://hexdocs.pm/swoosh</span><span class="w">
  </span><span class="c1">#   * Bamboo - https://hexdocs.pm/bamboo</span><span class="w">
  </span><span class="c1">#</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">deliver</span><span class="p" data-group-id="2714459088-8">(</span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="n">subject</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="2714459088-8">)</span><span class="w"> </span><span class="k" data-group-id="2714459088-9">do</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="2714459088-10">(</span><span class="s">&quot;Sending email to </span><span class="si" data-group-id="2714459088-11">#{</span><span class="n">to</span><span class="si" data-group-id="2714459088-11">}</span><span class="s"> with subject </span><span class="si" data-group-id="2714459088-12">#{</span><span class="n">subject</span><span class="si" data-group-id="2714459088-12">}</span><span class="s"> and body </span><span class="si" data-group-id="2714459088-13">#{</span><span class="n">body</span><span class="si" data-group-id="2714459088-13">}</span><span class="s">&quot;</span><span class="p" data-group-id="2714459088-10">)</span><span class="w">

    </span><span class="n">new</span><span class="p" data-group-id="2714459088-14">(</span><span class="p" data-group-id="2714459088-14">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">from</span><span class="p" data-group-id="2714459088-15">(</span><span class="p" data-group-id="2714459088-16">{</span><span class="s">&quot;Zach&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;zach@ash-hq.org&quot;</span><span class="p" data-group-id="2714459088-16">}</span><span class="p" data-group-id="2714459088-15">)</span><span class="w"> </span><span class="c1"># TODO: Replace with your email</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">to</span><span class="p" data-group-id="2714459088-17">(</span><span class="n">to_string</span><span class="p" data-group-id="2714459088-18">(</span><span class="n">to</span><span class="p" data-group-id="2714459088-18">)</span><span class="p" data-group-id="2714459088-17">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">subject</span><span class="p" data-group-id="2714459088-19">(</span><span class="n">subject</span><span class="p" data-group-id="2714459088-19">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_provider_option</span><span class="p" data-group-id="2714459088-20">(</span><span class="ss">:track_links</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;None&quot;</span><span class="p" data-group-id="2714459088-20">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">html_body</span><span class="p" data-group-id="2714459088-21">(</span><span class="n">body</span><span class="p" data-group-id="2714459088-21">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Example.Mailer</span><span class="o">.</span><span class="n">deliver!</span><span class="p" data-group-id="2714459088-22">(</span><span class="p" data-group-id="2714459088-22">)</span><span class="w">
  </span><span class="k" data-group-id="2714459088-9">end</span><span class="w">
</span><span class="k" data-group-id="2714459088-1">end</span></code></pre><p>Your new reset password functionality is active. Visit <a href="http://localhost:4000/sign-in"><code class="inline">localhost:4000/sign-in</code></a> with your browser and click on the <code class="inline">Forgot your password?</code> link to trigger the reset password workflow.</p>
<div class="bottom-actions">
  <div class="bottom-actions-item">

      <a href="readme.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
README
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="liveview.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Setting up your routes for LiveView
        </span>
      </a>

  </div>
</div>
      <footer class="footer">
        <p>

            <span class="line">
              <a href="https://hex.pm/packages/ash_authentication_phoenix/2.1.1" class="footer-hex-package">Hex Package</a>

              <a href="https://preview.hex.pm/preview/ash_authentication_phoenix/2.1.1">Hex Preview</a>

                (<a href="https://preview.hex.pm/preview/ash_authentication_phoenix/2.1.1/show/documentation/tutorials/get-started.md">current file</a>)

            </span>

          <span class="line">
            <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
              Search HexDocs
            </button>

          </span>
        </p>

        <p class="built-using">
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.31.1) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</main>
</div>


  </body>
</html>
