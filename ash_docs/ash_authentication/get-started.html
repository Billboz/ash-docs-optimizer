<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.34.2">
    <meta name="project" content="ash_authentication v4.0.4">


    <title>Get started with Ash Authentication — ash_authentication v4.0.4</title>
    <link rel="stylesheet" href="dist/html-elixir-F2VRIOKR.css" />


    <script src="dist/handlebars.runtime-NWIB6V2M.js"></script>
    <script src="dist/handlebars.templates-K7URE6B4.js"></script>
    <script src="dist/sidebar_items-BF9EDA45.js"></script>
    <script src="docs_config.js"></script>
    <script async src="dist/html-YIPIRHGU.js"></script>
<script>
  if (location.hostname === "hexdocs.pm") {
    var script = document.createElement("script");
    script.src = "https://plausible.io/js/script.js";
    script.setAttribute("defer", "defer")
    script.setAttribute("data-domain", "ashhexdocs")
    document.head.appendChild(script);
  }
</script>

  </head>
  <body data-type="extras" class="page-extra">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="readme.html" class="sidebar-projectImage">
          <img src="assets/logo.png" alt="ash_authentication" />
        </a>

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
ash_authentication
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v4.0.4
        </div>
      </div>
    </div>
    <ul id="sidebar-listNav" class="sidebar-listNav" role="tablist">
      <li>
        <button id="extras-list-tab-button" role="tab" data-type="extras" aria-controls="extras-tab-panel" aria-selected="true" tabindex="0">
GUIDES
        </button>
      </li>

        <li>
          <button id="modules-list-tab-button" role="tab" data-type="modules" aria-controls="modules-tab-panel" aria-selected="false" tabindex="-1">
            Modules
          </button>
        </li>


    </ul>
  </div>

  <div id="extras-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="extras-list-tab-button">
    <ul id="extras-full-list" class="full-list"></ul>
  </div>

    <div id="modules-tab-panel" class="sidebar-tabpanel" role="tabpanel" aria-labelledby="modules-list-tab-button" hidden>
      <ul id="modules-full-list" class="full-list"></ul>
    </div>


</nav>

<main class="content">
  <output role="status" id="toast"></output>

  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of ash_authentication</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search">
            <i class="ri-search-2-line ri-lg" aria-hidden="true" title="Submit search"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <h1>

      <a href="https://github.com/team-alembic/ash_authentication/blob/main/documentation/tutorials/get-started.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>


    <span>Get started with Ash Authentication</span>
  </h1>

<p>If you haven't already, read <a href="https://ash-hq.org/docs/guides/ash/latest/tutorials/get-started.md">the getting started guide for
Ash</a>. This
assumes that you already have resources set up, and only gives you the steps to
add authentication to your resources and APIs.</p><h2 id="add-to-your-application-s-dependencies" class="section-heading">
  <a href="#add-to-your-application-s-dependencies" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Add to your application's dependencies</span>
</h2>
<p>Bring in the <code class="inline">ash_authentication</code> dependency:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># mix.exs</span><span class="w">

</span><span class="kd">defp</span><span class="w"> </span><span class="nf">deps</span><span class="p" data-group-id="2926157199-1">(</span><span class="p" data-group-id="2926157199-1">)</span><span class="w">
  </span><span class="p" data-group-id="2926157199-2">[</span><span class="w">
    </span><span class="c1"># ...</span><span class="w">
    </span><span class="p" data-group-id="2926157199-3">{</span><span class="ss">:ash_authentication</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 4.0&quot;</span><span class="p" data-group-id="2926157199-3">}</span><span class="w">
  </span><span class="p" data-group-id="2926157199-2">]</span><span class="w">
</span><span class="k">end</span></code></pre><p>And add <code class="inline">ash_authentication</code> to your <code class="inline">.formatter.exs</code>:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># .formatter.exs</span><span class="w">
</span><span class="p" data-group-id="3379172754-1">[</span><span class="w">
  </span><span class="ss">import_deps</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3379172754-2">[</span><span class="n">...</span><span class="p">,</span><span class="w"> </span><span class="ss">:ash_authentication</span><span class="p" data-group-id="3379172754-2">]</span><span class="w">
</span><span class="p" data-group-id="3379172754-1">]</span></code></pre><h2 id="choosing-your-extensions-strategies-and-add-ons" class="section-heading">
  <a href="#choosing-your-extensions-strategies-and-add-ons" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Choosing your extensions, strategies and add-ons</span>
</h2>
<p>Ash Authentication supports many different features, each configured separately.</p><h3 id="ashauthentication" class="section-heading">
  <a href="#ashauthentication" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text"><a href="AshAuthentication.html"><code class="inline">AshAuthentication</code></a></span>
</h3>
<p>This is the core extension, and is required. It provides main DSL for working
with authentication and related features and should be added to your &quot;user&quot;
resource.</p><p>The <a href="AshAuthentication.html"><code class="inline">AshAuthentication</code></a> extension provides configuration and sensible defaults for settings which relate to authentication, regardless of authentication mechanism.</p><p>All strategy and add-on configuration is nested inside this DSL block.</p><p>It will define a <code class="inline">get_by_subject_name</code> read action on your resource, which is
used when converting tokens or session information into a resource record.</p><h3 id="ashauthentication-strategy-password" class="section-heading">
  <a href="#ashauthentication-strategy-password" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text"><a href="AshAuthentication.Strategy.Password.html"><code class="inline">AshAuthentication.Strategy.Password</code></a></span>
</h3>
<p>This authentication strategy provides registration and sign-in for users using a local
identifier (eg <code class="inline">username</code>, <code class="inline">email</code> or <code class="inline">phone_number</code>) and a password. It will
define register and sign-in actions on your &quot;user&quot; resource. You are welcome to
define either or both of these actions yourself if you wish to customise them -
if you do so then the extension will do its best to validate that all required
configuration is present.</p><p>The <a href="AshAuthentication.Strategy.Password.html"><code class="inline">AshAuthentication.Strategy.Password</code></a> DSL allows you to override any of the default values.</p><h3 id="ashauthentication-strategy-oauth2" class="section-heading">
  <a href="#ashauthentication-strategy-oauth2" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text"><a href="AshAuthentication.Strategy.OAuth2.html"><code class="inline">AshAuthentication.Strategy.OAuth2</code></a></span>
</h3>
<p>This authentication strategy provides registration and sign-in for users using a
remote <a href="https://oauth.net/2/">OAuth 2.0</a> server as the source of truth. You
will be required to provide either a &quot;register&quot; or a &quot;sign-in&quot; action depending
on your configuration, which the strategy will attempt to validate for common
misconfigurations.</p><h3 id="ashauthentication-addon-confirmation" class="section-heading">
  <a href="#ashauthentication-addon-confirmation" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text"><a href="AshAuthentication.AddOn.Confirmation.html"><code class="inline">AshAuthentication.AddOn.Confirmation</code></a></span>
</h3>
<p>This add-on allows you to confirm changes to a user record by generating and
sending them a confirmation token which they must submit before allowing the
change to take place.</p><h3 id="ashauthentication-tokenresource" class="section-heading">
  <a href="#ashauthentication-tokenresource" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text"><a href="AshAuthentication.TokenResource.html"><code class="inline">AshAuthentication.TokenResource</code></a></span>
</h3>
<p>This extension allows you to easily create a resource which will store
information about tokens that can't be encoded into the tokens themselves. A
resource with this extension must be present if token generation is enabled.</p><h3 id="ashauthentication-useridentity" class="section-heading">
  <a href="#ashauthentication-useridentity" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text"><a href="AshAuthentication.UserIdentity.html"><code class="inline">AshAuthentication.UserIdentity</code></a></span>
</h3>
<p>If you plan to support multiple different strategies at once (eg giving your
users the choice of more than one authentication provider, or signing them into
multiple services simultaneously) then you will want to create a resource with
this extension enabled. It is used to keep track of the links between your
local user records and their many remote identities.</p><h2 id="example" class="section-heading">
  <a href="#example" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Example</span>
</h2>
<p>Let's create an <code class="inline">Accounts</code> domain in our application which provides a <code class="inline">User</code>
resource and a <code class="inline">Token</code> resource.</p><p>First, let's define our domain:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/my_app/accounts.ex</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Accounts</span><span class="w"> </span><span class="k" data-group-id="7500257216-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Domain</span><span class="w">

  </span><span class="n">resources</span><span class="w"> </span><span class="k" data-group-id="7500257216-2">do</span><span class="w">
    </span><span class="n">resource</span><span class="w"> </span><span class="nc">MyApp.Accounts.User</span><span class="w">
    </span><span class="n">resource</span><span class="w"> </span><span class="nc">MyApp.Accounts.Token</span><span class="w">
  </span><span class="k" data-group-id="7500257216-2">end</span><span class="w">
</span><span class="k" data-group-id="7500257216-1">end</span></code></pre><p>Be sure to add it to the <code class="inline">ash_domains</code> config in your <code class="inline">config.exs</code></p><pre><code class="makeup elixir" translate="no"><span class="c1"># in config/config.exs</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:my_app</span><span class="p">,</span><span class="w"> </span><span class="ss">ash_domains</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="4951760873-1">[</span><span class="n">...</span><span class="p">,</span><span class="w"> </span><span class="nc">MyApp.Accounts</span><span class="p" data-group-id="4951760873-1">]</span></code></pre><p>Next, let's define our <code class="inline">Token</code> resource. This resource is needed
if token generation is enabled for any resources in your application. Most of
the contents are auto-generated, so we just need to provide the data layer
configuration and the API to use.</p><p>But before we do, we need to install a postgres extension.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/my_app/repo.ex</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Repo</span><span class="w"> </span><span class="k" data-group-id="1656975022-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">AshPostgres.Repo</span><span class="p">,</span><span class="w"> </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:my_app</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">installed_extensions</span><span class="w"> </span><span class="k" data-group-id="1656975022-2">do</span><span class="w">
    </span><span class="p" data-group-id="1656975022-3">[</span><span class="s">&quot;ash-functions&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uuid-ossp&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;citext&quot;</span><span class="p" data-group-id="1656975022-3">]</span><span class="w">
  </span><span class="k" data-group-id="1656975022-2">end</span><span class="w">
</span><span class="k" data-group-id="1656975022-1">end</span></code></pre><p>You can skip this step if you don't want to use tokens, in which case remove the
<code class="inline">tokens</code> DSL section in the user resource below.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/my_app/accounts/token.ex</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Accounts.Token</span><span class="w"> </span><span class="k" data-group-id="0267501747-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">AshPostgres.DataLayer</span><span class="p">,</span><span class="w">
    </span><span class="ss">extensions</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0267501747-2">[</span><span class="nc">AshAuthentication.TokenResource</span><span class="p" data-group-id="0267501747-2">]</span><span class="p">,</span><span class="w">
    </span><span class="c1"># If using policies, enable the policy authorizer:</span><span class="w">
    </span><span class="c1"># authorizers: [Ash.Policy.Authorizer],</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Accounts</span><span class="w">

  </span><span class="n">postgres</span><span class="w"> </span><span class="k" data-group-id="0267501747-3">do</span><span class="w">
    </span><span class="n">table</span><span class="w"> </span><span class="s">&quot;tokens&quot;</span><span class="w">
    </span><span class="n">repo</span><span class="w"> </span><span class="nc">MyApp.Repo</span><span class="w">
  </span><span class="k" data-group-id="0267501747-3">end</span><span class="w">

  </span><span class="c1"># If using policies, add the following bypass:</span><span class="w">
  </span><span class="c1"># policies do</span><span class="w">
  </span><span class="c1">#   bypass AshAuthentication.Checks.AshAuthenticationInteraction do</span><span class="w">
  </span><span class="c1">#     authorize_if always()</span><span class="w">
  </span><span class="c1">#   end</span><span class="w">
  </span><span class="c1"># end</span><span class="w">
</span><span class="k" data-group-id="0267501747-1">end</span></code></pre><p>Lastly let's define our <code class="inline">User</code> resource, using password authentication and token
generation enabled.</p><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/my_app/accounts/user.ex</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Accounts.User</span><span class="w"> </span><span class="k" data-group-id="8543576124-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Ash.Resource</span><span class="p">,</span><span class="w">
    </span><span class="ss">data_layer</span><span class="p">:</span><span class="w"> </span><span class="nc">AshPostgres.DataLayer</span><span class="p">,</span><span class="w">
    </span><span class="ss">extensions</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8543576124-2">[</span><span class="nc">AshAuthentication</span><span class="p" data-group-id="8543576124-2">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">authorizers</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8543576124-3">[</span><span class="nc">Ash.Policy.Authorizer</span><span class="p" data-group-id="8543576124-3">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">domain</span><span class="p">:</span><span class="w"> </span><span class="nc">MyApp.Accounts</span><span class="w">

  </span><span class="n">attributes</span><span class="w"> </span><span class="k" data-group-id="8543576124-4">do</span><span class="w">
    </span><span class="n">uuid_primary_key</span><span class="w"> </span><span class="ss">:id</span><span class="w">
    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:email</span><span class="p">,</span><span class="w"> </span><span class="ss">:ci_string</span><span class="p">,</span><span class="w"> </span><span class="ss">allow_nil?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">public?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
    </span><span class="n">attribute</span><span class="w"> </span><span class="ss">:hashed_password</span><span class="p">,</span><span class="w"> </span><span class="ss">:string</span><span class="p">,</span><span class="w"> </span><span class="ss">allow_nil?</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w"> </span><span class="ss">sensitive?</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="k" data-group-id="8543576124-4">end</span><span class="w">

  </span><span class="n">authentication</span><span class="w"> </span><span class="k" data-group-id="8543576124-5">do</span><span class="w">
    </span><span class="n">strategies</span><span class="w"> </span><span class="k" data-group-id="8543576124-6">do</span><span class="w">
      </span><span class="n">password</span><span class="w"> </span><span class="ss">:password</span><span class="w"> </span><span class="k" data-group-id="8543576124-7">do</span><span class="w">
        </span><span class="n">identity_field</span><span class="w"> </span><span class="ss">:email</span><span class="w">
      </span><span class="k" data-group-id="8543576124-7">end</span><span class="w">
    </span><span class="k" data-group-id="8543576124-6">end</span><span class="w">

    </span><span class="n">tokens</span><span class="w"> </span><span class="k" data-group-id="8543576124-8">do</span><span class="w">
      </span><span class="n">enabled?</span><span class="w"> </span><span class="no">true</span><span class="w">
      </span><span class="n">token_resource</span><span class="w"> </span><span class="nc">MyApp.Accounts.Token</span><span class="w">
      </span><span class="n">signing_secret</span><span class="w"> </span><span class="k" data-group-id="8543576124-9">fn</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">Application</span><span class="o">.</span><span class="n">fetch_env</span><span class="p" data-group-id="8543576124-10">(</span><span class="ss">:my_app</span><span class="p">,</span><span class="w"> </span><span class="ss">:token_signing_secret</span><span class="p" data-group-id="8543576124-10">)</span><span class="w">
      </span><span class="k" data-group-id="8543576124-9">end</span><span class="w">
    </span><span class="k" data-group-id="8543576124-8">end</span><span class="w">
  </span><span class="k" data-group-id="8543576124-5">end</span><span class="w">

  </span><span class="n">postgres</span><span class="w"> </span><span class="k" data-group-id="8543576124-11">do</span><span class="w">
    </span><span class="n">table</span><span class="w"> </span><span class="s">&quot;users&quot;</span><span class="w">
    </span><span class="n">repo</span><span class="w"> </span><span class="nc">MyApp.Repo</span><span class="w">
  </span><span class="k" data-group-id="8543576124-11">end</span><span class="w">

  </span><span class="n">identities</span><span class="w"> </span><span class="k" data-group-id="8543576124-12">do</span><span class="w">
    </span><span class="n">identity</span><span class="w"> </span><span class="ss">:unique_email</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8543576124-13">[</span><span class="ss">:email</span><span class="p" data-group-id="8543576124-13">]</span><span class="w">
  </span><span class="k" data-group-id="8543576124-12">end</span><span class="w">

  </span><span class="c1"># You can customize this if you wish, but this is a safe default that</span><span class="w">
  </span><span class="c1"># only allows user data to be interacted with via AshAuthentication.</span><span class="w">
  </span><span class="n">policies</span><span class="w"> </span><span class="k" data-group-id="8543576124-14">do</span><span class="w">
    </span><span class="n">bypass</span><span class="w"> </span><span class="nc">AshAuthentication.Checks.AshAuthenticationInteraction</span><span class="w"> </span><span class="k" data-group-id="8543576124-15">do</span><span class="w">
      </span><span class="n">authorize_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="8543576124-16">(</span><span class="p" data-group-id="8543576124-16">)</span><span class="w">
    </span><span class="k" data-group-id="8543576124-15">end</span><span class="w">

    </span><span class="n">policy</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="8543576124-17">(</span><span class="p" data-group-id="8543576124-17">)</span><span class="w"> </span><span class="k" data-group-id="8543576124-18">do</span><span class="w">
      </span><span class="n">forbid_if</span><span class="w"> </span><span class="n">always</span><span class="p" data-group-id="8543576124-19">(</span><span class="p" data-group-id="8543576124-19">)</span><span class="w">
    </span><span class="k" data-group-id="8543576124-18">end</span><span class="w">
  </span><span class="k" data-group-id="8543576124-14">end</span><span class="w">
</span><span class="k" data-group-id="8543576124-1">end</span></code></pre><p>Here we've added password authentication, using an email address as our
identifier.</p><p>Now we have enough in place to register and sign-in users using the
<a href="AshAuthentication.Strategy.html"><code class="inline">AshAuthentication.Strategy</code></a> protocol.</p><h2 id="token-generation" class="section-heading">
  <a href="#token-generation" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Token generation</span>
</h2>
<p>If you have token generation enabled then you need to provide (at minimum) a
signing secret. As the name implies this should be a secret. AshAuthentication
provides a mechanism for looking up secrets at runtime using the
<a href="AshAuthentication.Secret.html"><code class="inline">AshAuthentication.Secret</code></a> behaviour. To save you a click, this means that you
can set your token signing secret using either a static string (please don't!),
a two-arity anonymous function, or a module which implements the
<a href="AshAuthentication.Secret.html"><code class="inline">AshAuthentication.Secret</code></a> behaviour.</p><p>At its simplest you should so something like this:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in lib/my_app/accounts/user.ex</span><span class="w">

</span><span class="n">signing_secret</span><span class="w"> </span><span class="k" data-group-id="6059225837-1">fn</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="nc">Application</span><span class="o">.</span><span class="n">fetch_env</span><span class="p" data-group-id="6059225837-2">(</span><span class="ss">:my_app</span><span class="p">,</span><span class="w"> </span><span class="ss">:token_signing_secret</span><span class="p" data-group-id="6059225837-2">)</span><span class="w">
</span><span class="k" data-group-id="6059225837-1">end</span></code></pre><p>Then, specify the secret token in the config file:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># in config/config.exs</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:my_app</span><span class="p">,</span><span class="w"> </span><span class="ss">:token_signing_secret</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;some_super_secret_random_value&quot;</span></code></pre><blockquote><h3 id="the-signing-secret-must-not-be-committed-to-source-control" class="warning section-heading">
  <a href="#the-signing-secret-must-not-be-committed-to-source-control" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">The signing secret must not be committed to source control</span>
</h3>
<p>Proper management of secrets is outside the scope of this tutorial, but is
absolutely crucial to the security of your application.</p></blockquote><h2 id="plugs-and-routing" class="section-heading">
  <a href="#plugs-and-routing" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Plugs and routing</span>
</h2>
<p>If you're using Phoenix, then you can skip this section and go straight to
<a href="https://ash-hq.org/docs/guides/ash_authentication_phoenix/latest/tutorials/getting-started-with-ash-authentication-phoenix">Integrating Ash Authentication and Phoenix</a></p><p>In order for your users to be able to sign in, you will likely need to provide
an HTTP endpoint to submit credentials or OAuth requests to. Ash Authentication
provides <a href="AshAuthentication.Plug.html"><code class="inline">AshAuthentication.Plug</code></a> for this purposes. It provides a <code class="inline">use</code> macro
which handles routing of requests to the correct providers, and defines
callbacks for successful and unsuccessful outcomes.</p><p>Let's generate our plug:</p><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/my_app/auth_plug.ex</span><span class="w">

</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.AuthPlug</span><span class="w"> </span><span class="k" data-group-id="6867018173-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">AshAuthentication.Plug</span><span class="p">,</span><span class="w"> </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:my_app</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_success</span><span class="p" data-group-id="6867018173-2">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_activity</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p" data-group-id="6867018173-2">)</span><span class="w"> </span><span class="k" data-group-id="6867018173-3">do</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="n">is_api_request?</span><span class="p" data-group-id="6867018173-4">(</span><span class="n">conn</span><span class="p" data-group-id="6867018173-4">)</span><span class="w"> </span><span class="k" data-group-id="6867018173-5">do</span><span class="w">
      </span><span class="n">conn</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">send_resp</span><span class="p" data-group-id="6867018173-6">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="nc">Jason</span><span class="o">.</span><span class="n">encode!</span><span class="p" data-group-id="6867018173-7">(</span><span class="p" data-group-id="6867018173-8">%{</span><span class="w">
        </span><span class="ss">authentication</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6867018173-9">%{</span><span class="w">
          </span><span class="ss">success</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w">
          </span><span class="ss">token</span><span class="p">:</span><span class="w"> </span><span class="n">token</span><span class="w">
        </span><span class="p" data-group-id="6867018173-9">}</span><span class="w">
      </span><span class="p" data-group-id="6867018173-8">}</span><span class="p" data-group-id="6867018173-7">)</span><span class="p" data-group-id="6867018173-6">)</span><span class="w">
    </span><span class="k" data-group-id="6867018173-5">else</span><span class="w">
      </span><span class="n">conn</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">store_in_session</span><span class="p" data-group-id="6867018173-10">(</span><span class="n">user</span><span class="p" data-group-id="6867018173-10">)</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">send_resp</span><span class="p" data-group-id="6867018173-11">(</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="nc">EEx</span><span class="o">.</span><span class="n">eval_string</span><span class="p" data-group-id="6867018173-12">(</span><span class="s">&quot;&quot;&quot;
      &lt;h2&gt;Welcome back &lt;%= @user.email %&gt;&lt;/h2&gt;
      &quot;&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">user</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="6867018173-12">)</span><span class="p" data-group-id="6867018173-11">)</span><span class="w">
    </span><span class="k" data-group-id="6867018173-5">end</span><span class="w">
  </span><span class="k" data-group-id="6867018173-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_failure</span><span class="p" data-group-id="6867018173-13">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_activity</span><span class="p">,</span><span class="w"> </span><span class="c">_reason</span><span class="p" data-group-id="6867018173-13">)</span><span class="w"> </span><span class="k" data-group-id="6867018173-14">do</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="n">is_api_request?</span><span class="p" data-group-id="6867018173-15">(</span><span class="n">conn</span><span class="p" data-group-id="6867018173-15">)</span><span class="w"> </span><span class="k" data-group-id="6867018173-16">do</span><span class="w">
      </span><span class="n">conn</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">send_resp</span><span class="p" data-group-id="6867018173-17">(</span><span class="mi">401</span><span class="p">,</span><span class="w"> </span><span class="nc">Jason</span><span class="o">.</span><span class="n">encode!</span><span class="p" data-group-id="6867018173-18">(</span><span class="p" data-group-id="6867018173-19">%{</span><span class="w">
        </span><span class="ss">authentication</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="6867018173-20">%{</span><span class="w">
          </span><span class="ss">success</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
        </span><span class="p" data-group-id="6867018173-20">}</span><span class="w">
      </span><span class="p" data-group-id="6867018173-19">}</span><span class="p" data-group-id="6867018173-18">)</span><span class="p" data-group-id="6867018173-17">)</span><span class="w">
    </span><span class="k" data-group-id="6867018173-16">else</span><span class="w">
      </span><span class="n">conn</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">send_resp</span><span class="p" data-group-id="6867018173-21">(</span><span class="mi">401</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&lt;h2&gt;Incorrect email or password&lt;/h2&gt;&quot;</span><span class="p" data-group-id="6867018173-21">)</span><span class="w">
    </span><span class="k" data-group-id="6867018173-16">end</span><span class="w">
  </span><span class="k" data-group-id="6867018173-14">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">is_api_request?</span><span class="p" data-group-id="6867018173-22">(</span><span class="n">conn</span><span class="p" data-group-id="6867018173-22">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;application/json&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">get_req_header</span><span class="p" data-group-id="6867018173-23">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;accept&quot;</span><span class="p" data-group-id="6867018173-23">)</span><span class="w">
</span><span class="k" data-group-id="6867018173-1">end</span></code></pre><p>Now that this is done, you can forward HTTP requests to it from your app's main
router using <code class="inline">forward &quot;/auth&quot;, to: MyApp.AuthPlug</code> or similar.</p><p>Your generated auth plug module will also contain <code class="inline">load_from_session</code> and
<code class="inline">load_from_bearer</code> function plugs, which can be used to load users into assigns
based on the contents of the session store or <code class="inline">Authorization</code> header.</p><h2 id="supervisor" class="section-heading">
  <a href="#supervisor" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Supervisor</span>
</h2>
<p>AshAuthentication includes a supervisor which you should add to your
application's supervisor tree. This is used to run any periodic jobs related to
your authenticated resources (removing expired tokens, for example).</p><h3 id="example-1" class="section-heading">
  <a href="#example-1" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Example</span>
</h3>
<pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.Application</span><span class="w"> </span><span class="k" data-group-id="0778244299-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Application</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start</span><span class="p" data-group-id="0778244299-2">(</span><span class="c">_type</span><span class="p">,</span><span class="w"> </span><span class="c">_args</span><span class="p" data-group-id="0778244299-2">)</span><span class="w"> </span><span class="k" data-group-id="0778244299-3">do</span><span class="w">
    </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0778244299-4">[</span><span class="w">
      </span><span class="c1"># ...</span><span class="w">
      </span><span class="c1"># add this line --&gt;</span><span class="w">
      </span><span class="p" data-group-id="0778244299-5">{</span><span class="nc">AshAuthentication.Supervisor</span><span class="p">,</span><span class="w"> </span><span class="ss">otp_app</span><span class="p">:</span><span class="w"> </span><span class="ss">:my_app</span><span class="p" data-group-id="0778244299-5">}</span><span class="w">
      </span><span class="c1"># &lt;-- add this line</span><span class="w">
    </span><span class="p" data-group-id="0778244299-4">]</span><span class="w">
    </span><span class="c1"># ...</span><span class="w">
  </span><span class="k" data-group-id="0778244299-3">end</span><span class="w">
</span><span class="k" data-group-id="0778244299-1">end</span></code></pre><h2 id="summary" class="section-heading">
  <a href="#summary" class="hover-link">
    <i class="ri-link-m" aria-hidden="true"></i>
  </a>
  <span class="text">Summary</span>
</h2>
<p>In this guide we've learned how to install Ash Authentication, configure
resources and handle authentication HTTP requests.</p><p>You should now have an Ash application with working user authentication.</p><p>Up next, <a href="https://ash-hq.org/docs/guides/ash_authentication_phoenix/latest/tutorials/getting-started-with-ash-authentication-phoenix">Using with Phoenix</a>.</p>
</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="changelog.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Change Log
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="auth0.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Auth0 Tutorial
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/ash_authentication/4.0.4" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/ash_authentication/4.0.4">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/ash_authentication/4.0.4/show/documentation/tutorials/get-started.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="ash_authentication.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.34.2) for the

          <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
