# Getting started with AshPaperTrail — ash_paper_trail v0.1.4

Project: ash_paper_trail v0.1.4

## Table of Contents

- [ __ View Source ](external_link) Getting started with AshPaperTrail
  - __ Including version resources in your domain
    - __ Including all version resources:
    - __ Including specific version resources
  - __ Destroy Actions
  - __ Attributes
  - __ Change Tracking Modes
    - __ Snapshots
    - __ Changes Only
    - __ Full Diff
  - __ Associating Versions with Actors
  - __ Multitenancy
  - __ Enriching the Versions resource

__

Search documentation of ash_paper_trail __ __

__ Settings

#  [ __ View Source ](external_link) Getting started with AshPaperTrail

First, add the dependency to your `mix.exs`
    
    
    {:ash_paper_trail, "~> 0.1.4"}

Then, add the [`AshPaperTrail.Resource`](external_link) extension to any resource you would like to version and configure the change tracking mode
    
    
    use Ash.Resource,
      domain: MyDomain,
      extensions: [
        AshPaperTrail.Resource
      ]
    
      paper_trail do
        change_tracking_mode :changes_only # default is :snapshot
        store_action_name? true # default is false
        ignore_attributes [:inserted_at, :updated_at] # the primary keys are always ignored
      end

This will generate the version resource automatically and add them to your domain. The autogenerated resource will be named [`Version`](external_link) under the namespace of the original resource and will belong to the original resource. For example, if your original resource is `MyApp.Post` the autogenerated resource will be `MyApp.Post.Version`. `Post` has_many `paper_trail_versions` and [`Version`](external_link) belong_to `source_version`

##  __ Including version resources in your domain

First, add the [`AshPaperTrail.Domain`](external_link) extension to your domain.
    
    
    use Ash.Domain,
      extensions: [
        AshPaperTrail.Domain
      ]

###  __ Including all version resources:

Set `include_verisons? true` in the configuration, like so:
    
    
    paper_trail do
      include_versions? true
    end

###  __ Including specific version resources

Alternatively, you can configure individual version resources, like so:
    
    
    resources do
      resource MyApp.Post
      resource MyApp.Post.Version # <- add version resource
    end

##  __ Destroy Actions

If you are using `AshPostgres`, and you want to support destroy actions, you need to do one of two things:

  1. use something like `AshArchival` in conjunction with this resource to ensure that destroy actions are `soft?` and do not actually result in row deletion

  2. configure [`AshPaperTrail`](external_link) not to create references, via:



    
    
    paper_trail do
      reference_source? false
    end

##  __ Attributes

By default, attribute values are stored in the `changes` attribute. This is to protect you over time as your resources change. However, if there are attributes that you are confident will not change, you can create attributes for them on the version resource, like so:
    
    
    paper_trail do
      attributes_as_attributes [:organization_id, :author_id]
    end

This will make your version resource have `foo` and `bar` attributes (they will still show up in `changes`), i.e
    
    
    %ThingVersion{foo: "foo", bar: "bar", changes: %{"foo" => "foo", "bar" => "bar"}}

##  __ Change Tracking Modes

Valid options are `:snapshot` and `:changes_only` and `:full_diff`.

###  __ Snapshots

`:snapshot` will json dump the contents of every attribute whether they changed or not.

`{ subject: "new subject", body: "unchanged body", author: { name: "bob"}}`

###  __ Changes Only

`:changes_only` will json dump the contents of only the attributes that have changed. Note if any part of an embedded attribute and array of embedded attributes, changes then the entire top level attribute is dumped.

`{ subject: "new subject" }`

###  __ Full Diff

`:full_diff` will json dump the contents of each attribute.

`{ subject: { from: "subject", to: "new subject" }, body: { unchanged: "unchanged_body" }}, author: { changes: { unchanged: "bob" }}`

##  __ Associating Versions with Actors

You can record the actor who made the change by declaring one or more resources that can be actors.
    
    
    paper_trail do
      belongs_to_actor :user, MyApp.Accounts.User, domain: MyApp.Accounts
      belongs_to_actor :news_feed, MyApp.Accounts.NewsFeed, domain: MyApp.Accounts
    end

Each `belongs_to_actor` will create a `belongs_to` relationship with the given name destination. When creating a new version, if the actor on the action is set and matches the resource type, the version will be related to the actor. If your actors are polymorphic or varying types, declare a belongs_to_actor for each type.

A reference is also created with `on_delete: :nilify` and `on_update: :update`

If you need a more complex relationship or your actor is not a resource (e.g. String), the actor is always set on Version create and you can store it by adding `:on_create` `change` in a mixin.

##  __ Multitenancy

If your resource uses multitenancy, then the strategy, attribute, and parse_attribute options (if any) will be applied to the version resource. If using the attribute strategy you will need to ensure this is also an attribute on the version using the `attributes_as_attributes` option (described above) or via a mixin (described below)

##  __ Enriching the Versions resource

If you want to do something like exposing your versions resource over your graphql, you can use the `mixin` and `version_extensions` options.

For example:
    
    
    paper_trail do
      mixin {MyApp.MyResource.PaperTrailMixin, :graphql, [:my_resource_version]}
      relationship_opts public?: true
      version_extensions extensions: [AshGraphql.Resource]
    end

And then you can define a module like so:
    
    
    defmodule MyApp.MyResource.PaperTrailMixin do
    
      def graphql(type) do
        quote do
          graphql do
            type unquote(type)
    
            queries do
              list :list_versions, action: :read
            end
          end
        end
      end
    end

[ ← Previous Page  Home  ](external_link)

[ Next Page →  DSL: AshPaperTrail.Resource  ](external_link)
